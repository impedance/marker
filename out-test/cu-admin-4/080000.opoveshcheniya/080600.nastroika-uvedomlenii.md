# Настройка уведомлений

Контактные точки используются, чтобы указать, куда отправлять уведомления о событиях. Контактные точки содержат настройки для отправки уведомлений о событиях, включая такие адреса, как электронная почта, Slack, OnCall, вебхуки и их сообщения.

Контактная точка может иметь одно или несколько направлений, известных как интеграции контактных точек. Уведомления отправляются на каждую интеграцию в выбранной контактной точке.

На вкладке "Contact points (Контактные точки)" можно:

- добавлять, редактировать и просматривать контактные точки и интеграции;
- выполнять поиск по названию и типу контактных точек и интеграций;
- просматривать, для скольких политик уведомлений используется каждая контактная точка, и переходить непосредственно к связанным с ней политикам уведомлений;
- просматривать состояния доставки уведомлений;
- экспортировать отдельные контактные точки или все контактные точки в формате JSON, YAML или Terraform;
- удалять контактные точки. Следует обратить внимание, что нельзя удалить контактные точки, которые используются в политике уведомлений. Чтобы продолжить, следует либо удалить политику уведомлений, либо обновить ее, чтобы использовать другую контактную точку.

> Примечание – Контактные точки назначаются конкретному менеджеру оповещений и не могут использоваться политиками оповещений в других менеджерах оповещений.

## Архитектура Alertmanager

Для каждой интеграции контактных точек предусмотрены свои параметры конфигурации и процесс настройки. В следующем списке представлены интеграции контактных точек, поддерживаемые Подсистемой:

- Alertmanager;
- AWS SNS;
- Cisco Webex Teams;
- DingDing;
- Discord;
- Email;
- Google Chat;
- Grafana Oncall;
- Kafka REST Proxy;
- Line;
- Microsoft Teams;
- MQTT;
- Opsgenie;
- Pagerduty;
- Pushover;
- Sensu Go;
- Slack;
- Telegram;
- Threema Gateway;
- VictorOps;
- Webhook;
- WeCom.

Некоторые из перечисленных выше интеграций не поддерживаются Prometheus Alertmanager.

## Настройка контактных точек

Чтобы добавить контактную точку нужно выполнить следующие действия.

1. в меню слева выбрать "Alerting (Оповещения)  Contact points (Контактные точки)";
2. в раскрывающемся списке "Choice Alertmanager (Выбрать менеджер оповещений)" выбрать менеджер оповещений (по умолчанию выбран "Grafana Alertmanager");
3. на вкладке "Contact Points (Контактные точки)" нажать +Add contact point (Добавить контактную точку);
4. ввести описательное название контактной точки;
5. в секции "Integration (Интеграция)" выбрать тип интеграции и заполнить обязательные поля в зависимости от выбранного типа, например, если выбрана электронная почта, ввести адреса электронной почты;
6. некоторые интеграции с контактными точками, такие как электронная почта, имеют дополнительные настройки; в секции "Optional settings (Дополнительные настройки)" указать дополнительные параметры для выбранной интеграции с контактной точкой;
7. в настройках уведомлений можно дополнительно выбрать "Disable resolved message (Отключить сообщение о завершении)", если не требуется получать уведомления о завершении оповещения;
8. сохранить внесенные изменения, нажав кнопку Save contact points (Сохранить контактные точки).

### Поддерживаемые интеграции контактных точек

Контактная точка может иметь несколько интеграций или контактов для отправки уведомлений.

Чтобы добавить другую интеграцию к контактной точке, требуется выполнить следующие действия:

1. добавить или редактировать существующую контактную точку;
2. нажать +Add contact point integration (Добавить интеграцию контактной точки) и повторить те же действия, что и при добавлении контактных точек:
  1. в секции "Integration (Интеграция)" выбрать тип и заполнить обязательные поля;
    1. в "Optional settings (Дополнительные настройки)" указать дополнительные настройки для выбранной интеграции контактных точек;
3. сохранить внесенные изменения, нажав кнопку Save contact points (Сохранить контактные точки).

### Добавление контактной точки

В контактной точке также можно настроить сообщения уведомлений. Например, при настройке интеграции с контактной точкой по электронной почте следует нажать "Message (Сообщение)" или "Subject (Тема)", чтобы изменить их.

По умолчанию в сообщениях уведомлений содержатся общие сведения об оповещениях, которых обычно достаточно в большинстве случаев.

При необходимости можно изменить содержание и формат уведомлений. Возможно создать собственный шаблон уведомления, который затем можно применить к одной или нескольким контактным точкам.

На вкладке "Notification templates (Шаблоны уведомлений)" можно просматривать, редактировать, копировать или удалять шаблоны уведомлений.

### Добавление другой интеграции контактных точек

Тестирование контактной точки доступно только для Alertmanager. Чтобы протестировать контактную точку, нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  Contact points (Контактные точки)", чтобы просмотреть список существующих контактных точек;
2. на вкладке "Contact points (Контактные точки)" найти контактную точку, которую требуется протестировать, затем нажать Edit (Change (Изменить)); при необходимости также можно создать новую контактную точку;
3. нажать Test (Тест), чтобы открыть диалоговое окно тестирования контактной точки;
4. выбрать, требуется ли отправить предустановленное ("Predefined") тестовое уведомление или добавить собственные ("Custom") аннотации и метки в уведомление;
5. нажать Send test notification (Отправить тестовое уведомление), чтобы запустить оповещение.

### Настройка сообщений уведомлений

После создания контактной точки можно включить получение уведомлений с помощью одного из следующих способов:

- Assign it to alert rules (Назначить для правил оповещений) — выбрать контактную точку в параметрах оповещений для правил оповещений, управляемых Подсистемой, чтобы напрямую связать ее с конкретными оповещениями;
- Assign it to notification policies (Назначить для политик уведомлений) — добавить контактную точку в одну или несколько политик уведомлений, которые управляют оповещениями, которые требуется получать.

### Тестирование контактной точки

Политики уведомлений определяют, как оповещения направляются контактным точкам.

Политики имеют древовидную структуру. Каждая политика может иметь одну или несколько дочерних политик и набор сопоставлений меток.

Каждое оповещение (или экземпляр оповещения) оценивается политикой по умолчанию, а затем каждой дочерней политикой. Оповещения направляются в соответствующую политику уведомлений путем сопоставления меток оповещений с метками политики (рисунок 94).

::sign-image
---
src: /image133.png
sign: Схема работы политик уведомлений
---
::

Политика уведомлений, которой назначен экземпляр оповещения, отвечает за:

- группировку похожих оповещений для минимизации количества уведомлений;
- управление отправкой уведомлений с помощью параметров синхронизации;
- определение контактных точек, которые получают оповещение.

> Примечание – Политика уведомлений по умолчанию и дочерние политики назначаются конкретному менеджеру оповещений и не могут использовать точки взаимодействия или время отключения от других менеджеров оповещений.

### Включение уведомления для контактной точки

Для изменения политики уведомлений по умолчанию нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  "Notification policies (Политика уведомлений)";
2. в раскрывающемся списке "Choose Alertmanager (Выбрать менеджер оповещений)" выбрать внешний менеджер оповещений (по умолчанию выбран Alertmanager Подсистемы);
3. в секции "Политика по умолчанию" нажать  и выбрать "Edit (Изменить)";
  [Рисунок 553](/image134.png)
4. в появившемся диалоговом окне в списке "Default contact point (Контактная точка по умолчанию)" выбрать контактную точку, куда будут отправляться уведомления, если правила оповещений не соответствуют какой-либо конкретной политике;
5. в "Group by (Группировать по)" выбрать метки, чтобы сгруппировать оповещения; если несколько оповещений соответствуют этой политике, они группируются по выбранным меткам, и уведомления отправляются каждой группе;
6. в секции "Timing options (Параметры синхронизации)" настроить параметры синхронизации, чтобы указать время отправки уведомлений:
  - Group wait (Групповое ожидание) – время ожидания перед отправкой первого уведомления для новой группы оповещений; по умолчанию — 30 секунд;
  - Group interval (Интервал группы) – время ожидания перед отправкой уведомления об изменениях в группу оповещений; по умолчанию — 5 минут;
  - Repeat interval (Интервал повтора) – время ожидания перед отправкой уведомления, если группа не изменилась с момента последнего уведомления; по умолчанию — 4 часа;
7. нажать Update default policy (Обновить политику по умолчанию), чтобы сохранить внесенные изменения.

## Настройка политик уведомлений

Можно создать дочернюю политику в рамках политики по умолчанию или в рамках существующей дочерней политики:

1. в меню слева выбрать "Alerting (Оповещения)  "Notification policies (Политика уведомлений)";
2. в раскрывающемся списке "Choose Alertmanager (Выбрать диспетчер оповещений)" выбрать диспетчер оповещений (по умолчанию выбран Alertmanager Подсистемы);
3. нажать +New nested policy (Новая дочерняя политика) в политике по умолчанию или в существующей дочерней политике;
4. в секции "Matching labels (Совпадающие метки)" дочерней политики добавить одно или несколько правил для совпадающих меток, чтобы сузить область применения родительской политики;
5. в раскрывающемся списке "Contact point (Контактная точка)" выбрать контактную точку для отправки уведомлений; если оставить поле пустым, контактная точка родительской политики наследуется;
6. при необходимости включить "Continue matching subsequent sibling nodes (Продолжение сопоставления последующих родственных узлов)", чтобы продолжить сопоставление родственных политик даже после того, как оповещение будет соответствовать текущей политике; если эта опция включена, несколько политик могут обрабатывать одно и то же оповещение;
7. при необходимости включить "Override grouping (Переопределение группировки)", чтобы установить другую группировку, чем в родительской политике; если эта опция отключена, группировка родительской политики наследуется;
8. при необходимости включить "Override general timings (Переопределение общих параметров синхронизации)", чтобы задать другие параметры синхронизации, чем в родительской политике; если эта опция отключена, параметры синхронизации родительской политики наследуются;
9. нажать Update policy (Обновить политику), чтобы сохранить внесенные изменения.

### Изменение политики уведомлений по умолчанию

Для добавления политики родственных связей:

1. в меню слева выбрать "Alerting (Оповещения)  "Notification policies (Политика уведомлений)";
2. найти дочернюю политику, для которой требуется создать родственную связь;
3. нажать "+New nested policy (Добавить новую политику)";

Важно определить, какая политика получает оповещение первой, и установить правильный порядок политик для дочерних и родительских.

Политики оцениваются сверху вниз. Если найдена соответствующая политика, Подсистема продолжает оценивать дочерние политики в том порядке, в котором они отображаются.

1. следовать инструкциям, начиная с шага г), при добавлении дочерней политики в п.8.6.3.2.

### Добавление дочерней политики

Подсистема позволяет выполнять поиск в дереве политик по следующим параметрам:

- Label matchers (Сопоставление меток);
- Contact points (Контактные точки).

Чтобы выполнить поиск по контактной точке, нужно выбрать контактную точку в раскрывающемся списке "Search by contact point (Поиск по контактной точке)". Политики, использующие эту контактную точку, будут выделены в пользовательском интерфейсе.

Чтобы выполнить поиск по совпадающим меткам, просто ввести допустимое совпадение в поле ввода "Search by matchers (Поиск по совпадающим меткам)". Несколько совпадений можно объединить с помощью запятой ",".

Важно отметить, что все совпадающие политики являются точными совпадениями. Подсистема поддерживает регулярные выражения для создания сопоставления меток и не поддерживает регулярные выражения или частичное совпадение при поиске политик.

### Добавление политики родственных связей

Таймеры отключения не наследуются от родительской политики уведомлений и должны быть настроены на каждом уровне.

### Поиск политик

Таймер отключения — это повторяющийся интервал, который останавливает уведомления для одной или нескольких политик уведомлений в течение заданного периода. Он подавляет уведомления, но не прерывает оценку оповещений.

Можно использовать временные отключения, чтобы временно приостановить уведомления на определенный период, например, на время регулярного технического обслуживания или на выходные.

> Примечание – Таймеры отключения назначаются конкретному менеджеру оповещений и подавляют уведомления только для оповещений, управляемых этим менеджером.

### Таймеры отключения звука

Временное отключение звука и тишина — это разные способы подавления уведомлений. Они не препятствуют оценке правил оповещений и не останавливают появление оповещений в пользовательском интерфейсе, а только препятствуют созданию уведомлений.

В таблице 63 показаны ключевые различия между таймерами отключения звука и молчания.

1. Различия таймера звука и тишины

|  | **Отключение звука** | **Тишина** |
| --- | --- | --- |
| Setup (Настройка) | Создан и затем добавлен в политики уведомлений | Сопоставляет оповещения с помощью меток, чтобы определить, следует ли отключать их |
| Period (Период) | Использует определения временных интервалов, которые могут периодически повторяться | Имеет фиксированное время начала и окончания |

## Настройка таймеров отключения звука

Для добавления таймера отключения звука нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  "Notification policies (Политика уведомлений)";
2. перейти на вкладку "Mute Timings (Таймеры отключения звука)";
3. в раскрывающемся списке "Choose Alertmanager (Менеджер оповещений)" выбрать внешний менеджер оповещений (по умолчанию выбран Alertmanager Подсистемы);
4. нажать +Add mute timing (Добавить таймер отключения звука);
5. заполнить форму, чтобы создать временной интервал для таймера отключения звука;
6. сохранить таймер отключения звука, нажав Save mute timing (Сохранить таймер).

### Сравнение таймеров отключения звука против тишины

Для добавления таймера отключения звука в политику уведомлений нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  "Notification policies (Политика уведомлений)";
2. найти политику уведомлений, к которой требуется добавить отключение звука, нажать  и выбрать "Edit (Изменить)";
  [Рисунок 591](/image134.png)
3. в раскрывающемся списке "Mute Timings (Таймер отключения звука)" выбрать таймер отключения звука, который требуется добавить в политику;
4. сохранить внесенные изменения.

### Добавление таймеров отключения звука

Временной интервал — это определенная продолжительность, в течение которой оповещения не отображаются. Продолжительность обычно состоит из определенного временного диапазона и дней недели, месяца или года.

Таймер отключения звука может содержать несколько временных интервалов.

Поддерживаемые параметры временного интервала следующие:

- Диапазон времени – время, включающее начало и исключающее конец (в формате UTC, если не выбрано местоположение, в противном случае — по местному времени);
- Местоположение – в зависимости от выбранного местоположения диапазон времени отображается по местному времени;
- Дни недели – день или диапазон дней недели, например monday:thursday;
- Дни месяца – даты с 1 по 31 число месяца. Отрицательные значения также могут использоваться для обозначения дней, которые начинаются в конце месяца, например -1 для последнего дня месяца;
- Месяцы – месяцы года в числовом или полном календарном формате, например "1, may:august";
- Годы – год или годы для интервала, например 2021:2024.

Все поля являются списками; для соответствия полю должен быть задан хотя бы один элемент списка. Поля также поддерживают диапазоны с использованием ":" (например, monday:thursday).

Если поле оставлено пустым, любой момент времени соответствует этому полю. Чтобы момент времени соответствовал полному временному интервалу, все поля должны совпадать.

Если требуется указать точную продолжительность, необходимо указать все параметры.

### Добавление таймера отключения звука в политику уведомлений

Отключения звука останавливают создание уведомлений на заданный промежуток времени, но не прерывают оценку оповещений. Их используют, чтобы временно отключить уведомления об оповещениях, например, во время реагирования на инциденты или технического обслуживания.

### Временные интервалы

Чтобы добавить режим тишины, нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  Silences (Тишина)";
2. в раскрывающемся списке "Choose Alertmanager (Менеджер оповещений)" выбрать внешний менеджер оповещений для создания и управления режимами тишины для внешнего источника данных (по умолчанию – для Alertmanager Подсистемы);
3. нажать Create silence (Создать режим тишины);
4. в секции "Silence start and end (Начало и окончание тишины)" выбрать дату начала и окончания, чтобы указать, когда должна наступить и закончиться тишина;
5. при необходимости в поле "Duration (Продолжительность)" указать, на какое время устанавливается тишина – это автоматически обновит время окончания в поле "Silence start and end (Начало и конец тишины)";
6. в полях "Label (Метка)" и "Value (Значение)" ввести одну или несколько меток сопоставления, чтобы определить, к каким оповещениям применяется отключение; все соответствующие оповещения (только в состоянии срабатывания) отображаются в секции "Affected alert instances (Затронутые оповещения)";
7. в "Comment (Комментарии)" добавить подробности о тишине;
8. нажать Save silence (Сохранить режим тишины).

## Настройка режима тишины

Чтобы отредактировать режим тишины, нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  Silences (Тишина)", чтобы просмотреть список существующих;
2. найти режим тишины, который требуется отредактировать, затем нажать значок ;
  [Рисунок 599](/image135.png)
3. внести требуемые изменения, затем нажать Save silence (Сохранить режим тишины), чтобы сохранить внесенные изменения.

### Добавление режима тишины

Чтобы удалить режим тишины, нужно выполнить следующие действия:

1. в меню слева выбрать "Alerting (Оповещения)  Silences (Тишина)", чтобы просмотреть список существующих режимов;
2. выбрать режим тишины, который требуется прервать, затем нажать кнопку Unsilence (Отключить режим тишины).

> Примечание – Нельзя удалить тишину вручную. Завершившиеся сеансы тишины сохраняются и отображаются в течение пяти дней.

### Редактирование режима тишины

Режимы тишины для правил — это режимы тишины, которые применяются только к конкретному правилу оповещений. Они создаются, когда отключается правило оповещений напрямую с помощью действия "Silence notifications (Отключить уведомления)" в пользовательском интерфейсе.

В отличие от общего отключения, доступ к отключению для конкретного правила привязан непосредственно к правилу оповещения, на которое он влияет. Их можно создать вручную, включив в них специальный шаблон __alert_rule_uid__=<alert rule UID>.

### Отключение режима тишины

Уведомления по умолчанию часто содержат ссылку на оповещения о тишине.

В пользовательских шаблонах уведомлений можно использовать .Alert.SilenceURL для перенаправления пользователей в пользовательский интерфейс, где они могут отключить данное оповещение.

Если .Alert.SilenceURL не подходит для конкретного случая, также можно создать собственную ссылку для отключения звука для своих шаблонов.

### Режимы тишины, зависящее от правил

Чтобы изменить заголовок, сообщение и формат уведомлений можно использовать шаблоны уведомлений.

Подсистема предоставляет "Default template (Шаблон по умолчанию)" для заголовков уведомлений (default.title) и один шаблон по умолчанию для сообщений уведомлений (default.message). Оба шаблона отображают общие сведения об оповещениях.

Также можно создать шаблон уведомления, чтобы настроить содержание и формат пользовательских уведомлений, например:

- персонализировать тему электронного письма или заголовок сообщения;
- изменить текст в уведомлениях, например, выбрав или удалив определенные метки, аннотации и ссылки;
- отформатировать текст жирным шрифтом и курсивом, а также добавить или удалить разрывы строк.

Однако существуют ограничения, по которым нельзя:

- Изменение внешнего вида – добавлять HTML или CSS в уведомления по электронной почте для визуальных изменений; изменять дизайн уведомлений в сервисах обмена сообщениями, таких как Slack или Microsoft Teams;
- Управление мультимедиа и данными – настраивать структуру или формат данных, передаваемых в шаблоны; изменять HTTP-заголовки в вебхуках, выходящие за рамки тех, что определены в конфигурации, или настраивать количество, размер или расположение изображений.

> Примечание – Не следует добавлять дополнительную информацию о случаях оповещения в шаблоны уведомлений, так как эта информация будет видна только в сообщении уведомления.

Вместо этого следует использовать аннотации или метки для добавления информации непосредственно в оповещение, чтобы она также отображалась в состоянии оповещения и в истории оповещений в Подсистеме. Затем можно ввести новую аннотацию или метку оповещения в шаблонах уведомлений.

Шаблоны уведомлений не привязаны к конкретным контактным точкам, таким как электронная почта или Slack, и одним и тем же шаблоном можно пользоваться на несколько контактных точек.

Шаблон уведомления назначается контактной точке для определения сообщения уведомления, отправляемого в рамках интеграции с контактной точкой.

По умолчанию Подсистема предоставляет шаблоны по умолчанию, такие как "{{define "default.title"}}" и "{{define "default.message"}}", для форматирования сообщений уведомлений.

### URL-ссылка на форму режима тишины

Оповещения и уведомления об оповещениях должны предоставлять ключевую информацию, которая поможет специалистам по реагированию на инциденты и участникам инцидента понять, что произошло в их ИТ-инфраструктуре и как реагировать.

Раздел "Alerting (Оповещения)" позволяет отслеживать оповещения и управлять их настройкой. Возможно просматривать оповещения, отслеживать историю состояний оповещений и контролировать статус уведомлений. Это поможет начать расследование проблем с оповещениями в Подсистеме и повысить надежность системы оповещений.

В предыдущих разделах объясняется, как настроить правила оповещений и настроить уведомления для создания оповещений и отправки уведомлений.

В этом разделе рассказывается о том, как найти и понять состояние правил оповещений, экземпляров оповещений и их уведомлений.

## Шаблоны уведомлений

На странице просмотра списка правил оповещений перечислены все существующие правила записи и оповещения, в том числе созданные в Подсистеме и доступные в настроенных источниках данных.

Для просмотра правил оповещения нужно перейти в раздел " Alerting (Оповещения)  Alert rules (Правила оповещений)" (рисунок 95).

::sign-image
---
src: /image136.png
sign: Правила оповещений
---
::

По умолчанию правила оповещений группируются по типу: управляемые Подсистемой или управляемые источником данных.

В этом представлении можно находить и редактировать правила, созданные в Подсистеме. Однако правила, созданные в источниках данных, совместимых с Prometheus, отображаются, но не могут быть отредактированы.

Это представление включает фильтры, упрощающие управление большими объемами оповещений.

Возможно выполнять фильтрацию по источникам данных, панелям мониторинга и свойствам правил оповещений, таким как состояние, тип, работоспособность и контактные точки. Поле "Search (Поиск)" позволяет выполнять фильтрацию по дополнительным параметрам, таким как папки, группы оценки, метки и многое другое.

Также можно изменить способ отображения списка правил с помощью параметра "View as (Просмотр в виде)":

- Grouped (Сгруппировано) – (по умолчанию) отображает правила Подсистемы, сгруппированные по папкам и группам оценки, а также правила источников данных по пространствам имен и группам оценки;
- List (Список) – отображает правила Подсистемы, сгруппированные только по папкам;
- State (Статус) – отображает правила, сгруппированные по статусам, предоставляя обзор по каждому состоянию.

На рисунке 96 показан выбор группы для развертывания и просмотра списка правил оповещения внутри этой группы.

::sign-image
---
src: /image137.png
sign: Просмотр группы
---
::
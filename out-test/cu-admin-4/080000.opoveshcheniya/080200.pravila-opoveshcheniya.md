# Правила оповещения

Правила оповещений, управляемые источником данных, могут запрашивать только источники данных на основе Prometheus, такие как Prometheus, Mimir или Loki.

Правила оповещений хранятся в источнике данных. В этой распределенной архитектуре разделение компонентов может обеспечить высокую доступность и отказоустойчивость, позволяя масштабировать систему оповещений (рисунок 78).

::sign-image
---
src: /image123.png
sign: Схема работы правил, управляемых источником данных
---
::

Архитектура оповещения, управляемая Mimir:

- правила оповещения создаются и хранятся в самом источнике данных;
- правила оповещения могут запрашивать только данные, основанные на Prometheus;
- правила оповещения оцениваются механизмом оценки правил оповещения;
- запущенные и разрешенные экземпляры оповещений пересылаются для обработки их уведомлений.

## Правила оповещения, управляемые Подсистемой

По возможности рекомендуется использовать правила оповещений, управляемые Подсистемой, и выбирать правила оповещений, управляемые источником данных, только если нужно масштабировать систему оповещений.

В таблице 61 сравниваются правила оповещений, управляемые Подсистемой и источником данных.

1. Сравнение типов правил

| **Функция** | **Правило оповещения, управляемое Подсистемой** | **Правило оповещения, управляемое источником данных** |
| --- | --- | --- |
| Создание правил оповещения, которые запрашивают источники данных, поддерживающие оповещение | Да | Нет. Запрашиваются только источники данных на основе Prometheus |
| Комбинация источников данных | Да | Нет |
| Добавление выражений для преобразования данных и установка условия оповещения | Да | Нет |
| Использование изображений в уведомлениях об оповещениях | Да | Нет |
| Поддержка правил записи | Да | Да |
| Организация | Организация доступа с помощью папок и управление им | Использование пространства имен |
| Оценка и выдача правил оповещения | Оценка оповещений выполняется в Подсистеме, а их отправка может осуществляться с помощью Подсистемы или внешнего менеджера оповещений | Оценка правил оповещения и доставка оповещений распределены |
| Масштабирование | Правила оповещений хранятся в базе данных Подсистемы, в которой могут возникать временные ошибки. Она масштабируется только по вертикали | Правила оповещения хранятся в источнике данных и допускают горизонтальное масштабирование |

## Правила оповещения, управляемые источником данных

Как и правила оповещений, правила записи оцениваются периодически. Правило записи предварительно вычисляет часто используемые или ресурсоемкие запросы и сохраняет результаты в виде новой метрики временных рядов.

Затем новую метрику записи можно использовать в правилах оповещений и на панелях мониторинга для оптимизации запросов.

## Сравнение типов правил оповещений

Критерии, определяющие срабатывание правила оповещения, основаны на двух настройках (рисунок 79):

- группа оценки: как часто оценивается правило оповещения;
- период ожидания: как долго должно выполняться условие, чтобы начать запуск.

::sign-image
---
src: /image124.png
sign: Установка оценки правила оповещения
---
::

## Правила записи

Каждое правило оповещения назначается группе оценки. Возможно назначить правило оповещения существующей группе оценки или создать новую.

Каждая группа оценки содержит интервал оценки, который определяет, как часто проверяется правило оповещения. Например, оценка может выполняться каждые 10s, 30s, 1m, 10m и т. д.

Правила оповещения в разных группах могут оцениваться одновременно.

- Управляемые Подсистемой правила оповещений в одной группе оцениваются одновременно – они оцениваются в разное время в течение одного и того же интервала оценки, но отображаются с одной и той же меткой времени оценки;
- Управляемые источником данных правила оповещений в одной группе оцениваются последовательно, одно за другим. Это полезно для того, чтобы правила записи оценивались до правил оповещений.
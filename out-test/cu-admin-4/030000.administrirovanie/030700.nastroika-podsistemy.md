# Настройка Подсистемы

В Подсистеме есть возможность активной настройки, которая использует файлы конфигурации.

## Конфигурационный файл

Расположение файлов конфигурации:

- конфигурация по умолчанию – $WORKING_DIR/conf/defaults.ini;
- пользовательская конфигурация – $WORKING_DIR/conf/custom.ini;
- путь к файлу пользовательской конфигурации может быть переопределен с помощью параметра "--config".

## Переменные среды

Можно использовать интерполяцию переменных среды во всех трех типах конфигурации настройки. Допустимый синтаксис – $ENV_VAR_NAME или ${ENV_VAR_NAME}, и его можно использовать только для значений, а не для ключей или более крупных частей конфигурации. Если в значении переменной среды есть "$" (например, Pa$sw0rd), используют синтаксис $ENV_VAR_NAME во избежание двойного расширения. Он недоступен в файлах определения панели мониторинга, только в конфигурации настройки панели мониторинга.

Пример:

```yaml
datasources:
– name: Graphite
url: http://localhost:$PORT
user: $USER
secureJsonData:
password: $PASSWORD
```

Можно использовать "$$", если в значении есть литерал "$" и требуется избежать интерполяции.

## Источники данных

Можно управлять источниками данных в Подсистеме, добавляя файлы конфигурации YAML в директорию provisioning/datasources. Каждый файл конфигурации может содержать список datasources, который необходимо добавить или обновить во время запуска. Если источник данных уже существует, Подсистема перенастраивает его в соответствии с предоставленным файлом конфигурации.

В файле конфигурации также можно указать источники данных для автоматического удаления, которые называются deleteDatasources. Подсистема удаляет источники данных, перечисленные в deleteDatasources перед добавлением или обновлением источников из списка datasources.

Можно настроить Подсистему на автоматическое удаление подготовленных источников данных при их удалении из файла настройки. Для этого нужно добавить "prune: true" в начало файла настройки источника данных. При такой настройке Подсистема также удаляет подготовленные источники данных при полном удалении файла подготовки.

Если запускается несколько экземпляров Подсистемы, следует добавить номер версии для каждого источника данных в конфигурации и увеличивать его при обновлении конфигурации. Подсистема обновляет только источники данных с номером версии, равным или меньшим, чем указано в конфигурации. Это предотвращает перезапись старых конфигураций более новыми, если есть разные версии файла datasource.yaml, в которых не указаны номера версий, а затем перезапускать экземпляры одновременно.

## Данные в формате JSON

Не все источники данных имеют одинаковые параметры конфигурации. Чтобы задать другие параметры источника данных, их указывают в виде JSON-объекта в поле jsonData.

Общие настройки во встроенных источниках основных данных включают параметры из таблицы 5.

> Примечание – Источники данных, помеченные HTTP*, взаимодействуют по протоколу HTTP, который включает все основные плагины источников данных, кроме MySQL, PostgreSQL и MSSQL.

1. Параметры конфигурации JSON

| Имя | Тип | Источник данных | Описание |
| --- | --- | --- | --- |
| tlsAuth | Logical | HTTP*, MySQL | Включает проверку подлинности TLS с использованием клиентского сертификата, настроенного в защищенных данных JSON |
| tlsAuthWithCACert | Logical | HTTP*, MySQL, PostgreSQL | Включает проверку подлинности TLS с помощью CA cert |
| tlsskipVerify | Logical | HTTP*, MySQL, PostgreSQL, MSSQL | Определяет, проверяет ли клиент цепочку сертификатов сервера и имя хоста |
| serverName | String | HTTP*, MSSQL | Необязательно. Управляет именем сервера, используемым для проверки общего имени сертификата/альтернативного имени субъекта. По умолчанию используется URL-адрес источника данных |
| Timeout | String | HTTP* | Время ожидания запроса в секундах. Переопределяет параметр dataproxy.timeout |
| graphiteVersion | String | Graphite | Версия Graphite |
| timeInterval | String | Prometheus, Elasticsearch, InfluxDB, MySQL, PostgreSQL и MSSQL | Наименьшее значение интервала / шага, которое следует использовать для этого источника данных |
| httpMode | String | Influxdb | HTTP-метод. ‘GET’, ‘POST’ по умолчанию имеют значение GET |
| maxSeries | Number | Influxdb | Максимальное количество серий / таблиц, обрабатываемых Подсистемой |
| httpMethod | String | Prometheus | HTTP-метод. ‘GET’, ‘POST’ по умолчанию имеют значение POST |
| customQueryParameters | String | Prometheus | Параметры запроса для добавления в виде строки в кодировке URL |
| manageAlerts | Logical | Prometheus и Loki | Управляет оповещениями с помощью пользовательского интерфейса оповещения |
| alertmanagerUid | String | Prometheus и Loki | UID диспетчера оповещений, который управляет оповещением для этого источника данных |
| timeField | String | Elasticsearch | Какое поле следует использовать в качестве временной метки |
| interval | String | Elasticsearch | Формат даты и времени индекса. nil (без шаблона), "ежечасно", "ежедневно", "еженедельно", "ежемесячно" или "ежегодно" |
| logMessageField | String | Elasticsearch | Какое поле следует использовать в качестве сообщения журнала |
| logLevelField | String | Elasticsearch | Какое поле следует использовать для указания приоритета сообщения журнала |
| maxConcurrentShardRequests | Number | Elasticsearch | Максимальное количество одновременных сегментных запросов, выполняемых каждым вспомогательным поисковым запросом на узел |
| sigV4Auth | Logical | Elasticsearch и Prometheus | Включить использование SigV4 |
| Тип sigV4AuthType | String | Elasticsearch и Prometheus | Поставщик авторизации SigV4. по умолчанию / учетные данные / ключи |
| sigV4ExternalId | String | Elasticsearch и Prometheus | Дополнительный внешний идентификатор SigV4 |
| sigV4AssumeRoleArn | String | Elasticsearch и Prometheus | Необязательная роль SigV4 ARN |
| sigV4Region | String | Elasticsearch и Prometheus | Регион SigV4 AWS |
| Файл sigV4Profile | String | Elasticsearch и Prometheus | Дополнительный профиль учетных данных SigV4 |
| authType | String | Cloudwatch | Поставщик авторизации. по умолчанию / учетные данные / ключи |
| externalId | String | Cloudwatch | Дополнительный внешний идентификатор |
| assumeRoleArn | String | Cloudwatch | Необязательная роль ARN |
| defaultRegion | String | Cloudwatch | Необязательный регион AWS по умолчанию |
| customMetricsNamespaces | String | Cloudwatch | Пространства имен пользовательских метрик |
| profile | String | Cloudwatch | Дополнительный профиль учетных данных |
| tsdbVersion | String | OpenTSDB | Версия |
| tsdbResolution | String | OpenTSDB | Разрешение |
| sslmode | String | PostgreSQL | Режим SSL. "отключить", "потребовать", "проверить сертификат" или "проверить полностью" |
| tlsConfigurationMethod | String | PostgreSQL | Настройка SSL-сертификата с помощью "пути к файлу" или "содержимого файла" |
| sslRootCertFile | String | PostgreSQL, MSSQL | Файл корневого сертификата SSL-сервера должен быть доступен для чтения пользователю |
| sslCertFile | String | PostgreSQL | Файл сертификата клиента SSL, должен быть доступен для чтения пользователю |
| sslKeyFile | String | PostgreSQL | Файл ключа SSL-клиента должен быть доступен для чтения только пользователю |
| encrypt | String | MSSQL | Определяет обработку шифрования SSL. Возможные варианты: disable – данные, передаваемые между клиентом и сервером, не шифруются; false – данные, передаваемые между клиентом и сервером, не шифруются за пределами пакета входа в систему; true – данные, передаваемые между клиентом и сервером, шифруются. По умолчанию используется false |
| postgresVersion | Number | PostgreSQL | Версия Postgres в виде числа (903/904/905/906/1000) означает v9.3, v9.4, ..., v10 |
| timescaledb | Logical | PostgreSQL | Включить использование расширения TimescaleDB |
| maxOpenConns | Number | MySQL, PostgreSQL и MSSQL | Максимальное количество открытых подключений к базе данных |
| maxIdleConns | Number | MySQL, PostgreSQL и MSSQL | Максимальное количество подключений в пуле незанятых подключений |
| connMaxLifetime | Number | MySQL, PostgreSQL и MSSQL | Максимальное время в секундах, в течение которого соединение может быть использовано повторно |
| keepCookies | массив | HTTP* | Файлы cookie, которые необходимо передавать при общении с источниками данных |
| prometheusVersion | String | Prometheus | Версия источника данных Prometheus |
| prometheusType | String | Prometheus | Тип базы данных Prometheus. Возможны следующие варианты: Prometheus, Cortex, Mimir или Thanos |
| cacheLevel | String | Prometheus | Определяет продолжительность хранения данных в кеше браузера. Допустимые значения: Low, Medium, High и None. Это поле настраивается при включении флага prometheusResourceBrowserCache функции. |
| incrementalQuerying | String | Prometheus | Экспериментальный режим: включает инкрементальный запрос для повышения производительности перезагрузки панели мониторинга при использовании медленных источников данных |
| incrementalQueryOverlapWindow | String | Prometheus | Экспериментальный режим: настраивает окно перекрытия инкрементных запросов. Требуется корректная String продолжительности, например 180s или 15m Значение по умолчанию – 10m (10 минут). |
| disableRecordingRules | Logical | Prometheus | Экспериментальный режим: Отключает правила записи Prometheus |
| implementation | String | AlertManager | Реализация источника данных AlertManager, такого как prometheus, cortex или mimir |
| handleGrafanaManagedAlerts | Logical | AlertManager | Когда этот параметр включен, оповещения, управляемые Подсистемой, отправляются в Alertmanager |

## Защищенные данные в формате JSON

Защищенные данные JSON – это карта настроек, зашифрованных с помощью секретного ключа из конфигурации Подсистемы. Шифрование скрывает содержимое от пользователей приложения. Этот параметр следует использовать для хранения сертификата TLS и пароля, которые Подсистема добавляет к запросу на стороне сервера. Все эти параметры необязательны (таблица 6).

1. Защищенные параметры JSON

| Имя | Тип | Источник данных | Описание |
| --- | --- | --- | --- |
| tlsCACert | String | HTTP*, MySQL, PostgreSQL | Сертификат центра сертификации для исходящих запросов. Можно напрямую указать на сохраненный сертификат, используя переменную среды в формате $__file{path/to/ca} |
| tlsClientCert | String | HTTP*, MySQL, PostgreSQL | Сертификат клиента TLS для исходящих запросов. Можно указать непосредственно на сохраненный сертификат, используя переменную среды в формате $__file{path/to/cert} |
| tlsClientKey | String | HTTP*, MySQL, PostgreSQL | Ключ клиента TLS для исходящих запросов. Можно напрямую указать на сохраненный ключ, используя переменную среды в формате $__file{path/to/key} |
| password | String | HTTP*, MySQL, PostgreSQL, MSSQL | Пароль |
| basicAuthPassword | String | HTTP* | Пароль для базовой аутентификации |
| accessKey | String | Cloudwatch | Ключ доступа для подключения к Cloudwatch |
| secretKey | String | Cloudwatch | Секретный ключ для подключения к Cloudwatch |
| sigV4AccessKey | String | Elasticsearch и Prometheus | Ключ доступа SigV4. Требуется при использовании ключей поставщика аутентификации |
| sigV4SecretKey | String | Elasticsearch и Prometheus | Секретный ключ SigV4. Требуется при использовании провайдера аутентификации ключей. |

## Плагины

Можно управлять приложениями-плагинами в Подсистеме, добавив один или несколько файлов конфигурации YAML в каталог provisioning/plugins. Каждый файл конфигурации может содержать список apps. Подсистема обновляет каждое приложение в соответствии с файлом конфигурации.

> Примечание – Эта функция позволяет настраивать конфигурации плагинов, а не сами плагины. Плагины должны быть уже установлены в экземпляре Подсистемы.

## Панели мониторинга

Можно управлять панелями мониторинга в Подсистеме, добавив один или несколько файлов конфигурации YAML в каталог provisioning/dashboards. Каждый файл конфигурации может содержать список dashboards providers, которые загружают панели мониторинга в Подсистему из локальной файловой системы.

При запуске Подсистема обновляет и вставляет все панели мониторинга, доступные по заданному пути. Затем Подсистема опрашивает этот путь каждые updateIntervalSeconds, ищет обновленные файлы JSON, обновляет их и вставляет в базу данных.

> Примечание – Панели мониторинга настраиваются на корневом уровне, если параметр folder отсутствует или пуст.

Хотя и можно изменить подготовленную панель мониторинга в пользовательском интерфейсе Подсистемы, эти изменения нельзя сохранить в источнике настройки. Если allowUiUpdates установлено на true и вносятся изменения в подготовленную панель мониторинга, можно сохранить панель мониторинга, после чего изменения сохранятся в базе данных Подсистемы.

> Примечание – Если подготовленная панель мониторинга сохраняется в пользовательском интерфейсе, а затем обновляется из исходного источника, панель мониторинга, сохраненная в базе данных, всегда будет перезаписываться. Свойство version в файле JSON не повлияет на это, даже если оно ниже версии существующей панели мониторинга.

Если подготовленная панель мониторинга сохраняется в пользовательском интерфейсе, а источник удаляется, панель мониторинга, хранящаяся в базе данных, удаляется, если только для параметра конфигурации disableDeletion не установлено значение true.

Если allowUiUpdates настроено на false, нельзя вносить изменения в подготовленную панель мониторинга. При нажатии Save в Подсистеме появляется диалоговое окно "Не удается сохранить подготовленную панель мониторинга". На рисунке 6 показано это поведение.

Подсистема предлагает несколько вариантов экспорта определения панели мониторинга в формате JSON. Оба варианта "Copy JSON to Clipboard" или "Save JSON to file" помогут синхронизировать изменения панели мониторинга с источником данных.

> Примечание – В определении JSON в поле ввода при использовании "Copy JSON to Clipboard" или "Save JSON to file" поле id автоматически удаляется для упрощения процесса подготовки.

::sign-image
---
src: /image18.png
sign: Диалоговое окно с оповещением
---
::

Если панель мониторинга в файле JSON содержит UID, Подсистема принудительно вставляет/обновляет этот UID. Это позволяет переносить панели мониторинга между экземплярами Подсистемы и подготавливать их из конфигурации, не нарушая указанные URL-адреса, поскольку новый URL-адрес панели мониторинга использует UID в качестве идентификатора. При запуске Подсистемы обновляются и вставляются все панели мониторинга, доступные в настроенных папках. При изменении файла панель мониторинга также обновляется. По умолчанию Подсистема удаляет панели мониторинга в базе данных при удалении файла. Можно отключить это поведение с помощью параметра disableDeletion.

> Примечание – Подготовка позволяет перезаписывать существующие панели мониторинга, что приводит к проблемам при повторном использовании настроек, которые должны быть уникальными. Следует быть осторожными, и не использовать один и тот же заголовок несколько раз в папке или uid в рамках одной установки, поскольку это приводит к непредсказуемому поведению.

Если панели мониторинга хранятся с использованием папок в репозитории git или в файловой системе, а также требуется иметь те же имена папок в меню Подсистемы, можно использовать опцию foldersFromFilesStructure.

## Оповещения

В таблицах 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28-29 подробно описаны поддерживаемые настройки и безопасные настройки для каждого типа уведомлений. Безопасные настройки хранятся в зашифрованном виде в базе данных, и добавляются в secure_settings в файле YAML вместо settings.

1. Оповещение pushover

| Имя | Безопасная настройка |
| --- | --- |
| piToken | Да |
| userKey | Да |
| device |  |
| priority |  |
| okPriority |  |
| retry |  |
| expire |  |
| sound |  |
| okSound |  |

1. Оповещение discord

| Имя | Безопасная настройка |
| --- | --- |
| url | Да |
| avatar_url |  |
| content |  |
| use_discord_username |  |

1. Оповещение slack

| Имя | Безопасная настройка |
| --- | --- |
| url | Да |
| recipient |  |
| username |  |
| icon_emoji |  |
| icon_url |  |
| uploadImage |  |
| mentionUsers |  |
| mentionGroups |  |
| mentionChannel |  |
| token | Да |

1. Оповещение victorops

| Имя |
| --- |
| url |
| autoResolve |

1. Оповещение kafka

| Имя |
| --- |
| kafkaRestProxy |
| kafkaTopic |

1. Оповещение LINE

| Имя | Безопасная настройка |
| --- | --- |
| token | Да |

1. Оповещение MQTT

| Имя | Безопасная настройка |
| --- | --- |
| brokerUrl |  |
| clientId |  |
| topic |  |
| messageFormat |  |
| username |  |
| password | Да |
| retain |  |
| qos |  |
| tlsConfig |  |

1. TLS-конфигурация

| Имя | Безопасная настройка |
| --- | --- |
| insecureSkipVerify |  |
| clientCertificate | Да |
| clientKey | Да |
| caCertificate | Да |

1. Оповещение pagerduty

| Имя | Безопасная настройка |
| --- | --- |
| integrationKey | Да |
| autoResolve |  |

1. Оповещение sensu

| Имя | Безопасная настройка |
| --- | --- |
| url |  |
| source |  |
| handler |  |
| username |  |
| password | Да |

1. Оповещение sensugo

| Имя | Безопасная настройка |
| --- | --- |
| url |  |
| apikey | Да |
| entity |  |
| check |  |
| handler |  |
| namespace |  |

1. Оповещение prometheus-alertmanager

| Имя | Безопасная настройка |
| --- | --- |
| url |  |
| basicAuthUser |  |
| basicAuthPassword | Да |

1. Оповещение teams

| Имя |
| --- |
| url |

1. Оповещение dingding

| Имя |
| --- |
| url |

1. Оповещение email

| Имя |
| --- |
| singleEmail |
| addresses |

1. Оповещение hipchat

| Имя |
| --- |
| url |
| apikey |
| roomid |

1. Оповещение opsgenie

| Имя | Безопасная настройка |
| --- | --- |
| apiKey | Да |
| apiUrl |  |
| autoClose |  |
| overridePriority |  |
| sendTagsAs |  |

1. Оповещение telegram

| Имя | Безопасная настройка |
| --- | --- |
| bottoken | Да |
| chatid |  |
| uploadImage |  |

1. Оповещение threema

| Имя | Безопасная настройка |
| --- | --- |
| gateway_id |  |
| recipient_id |  |
| api_secret | Да |

1. Оповещение webhook

| Имя | Безопасная настройка |
| --- | --- |
| url |  |
| http_method |  |
| username |  |
| password | Да |
| tls_config |  |

1. Конфигурация TLS

| **Имя** | **Безопасная настройка** |
| --- | --- |
| insecureSkipVerify |  |
| clientCertificate | Да |
| clientKey | Да |
| caCertificate | Да |

1. Оповещение googlechat

| **Имя** |
| --- |
| url |

1. Оповещение Cisco Webex Teams

| **Имя** | **Безопасная настройка** |
| --- | --- |
| message |  |
| room_id |  |
| api_url |  |
| bot_token | Да |
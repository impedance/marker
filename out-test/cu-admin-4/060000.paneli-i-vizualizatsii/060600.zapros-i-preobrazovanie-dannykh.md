# Запрос и преобразование данных

Панель вкладки панели запроса состоит из следующих элементов (рисунок 43):

- Data source selector (Выбор источника данных) – выбор источника данных для запроса;
- Query options (Параметры запроса) – устанавливает максимальные параметры извлечения данных и интервалы времени выполнения запроса;
- Query inspector button (Кнопка проверки запросов) – открывает панель проверки запросов, где можно просмотреть и оптимизировать пользовательский запрос;
- Query editor list (Список редактора запросов) – содержит список ранее созданных запросов;
- Expressions (Выражения) – для создания выражений оповещений используется конструктор выражений.

::sign-image
---
src: /image76.png
sign: Вкладка запроса
---
::

## Обзор

Запрос возвращает данные, которые Подсистема визуализирует на панелях панели мониторинга. При создании панели Подсистема автоматически выбирает источник данных по умолчанию.

Чтобы добавить запрос, нужно выполнить следующие действия:

1. отредактировать панель, на которую добавляется запрос;
2. перейти на вкладку "Query (Запрос)";
3. нажать на раскрывающееся меню "Data source (Источник данных)" и выбрать источник данных;
4. если создается новая панель мониторинга, при добавлении первой панели будет предложено выбрать источник данных;
5. нажать "Query options (Параметры запроса)", чтобы настроить максимальное количество необходимых точек данных;
6. написать запрос с помощью редактора запросов;
7. нажать Apply (Применить).

Подсистема запрашивает источник данных и визуализирует данные.

## Навигация по вкладке запроса

Подсистема группирует запросы в сворачиваемые строки запросов. Каждая строка запроса содержит редактор запросов и обозначается буквой (A, B, C и так далее).

Для управления запросами можно воспользоваться значками, указанными в таблице 45.

1. Значки управления

| **Значок** | **Описание** |
| --- | --- |
| [Рисунок 546](/image77.png) | Открывает справку по редактору запросов. Если это поддерживается источником данных, нажать на этот значок, чтобы отобразить информацию о том, как использовать редактор запросов, или обеспечить быстрый доступ к распространенным запросам |
| [Рисунок 545](/image78.png) | Копирует запрос. Дублирование запросов полезно при работе с несколькими сложными запросами, которые похожи друг на друга, и требуется либо поэкспериментировать с разными вариантами, либо внести небольшие изменения |
| [Рисунок 544](/image79.png) | Скрывает запрос. Подсистема не отправляет скрытые запросы к источнику данных |
| [Рисунок 543](/image80.png) | Удаляет запрос. При удалении запроса он удаляется безвозвратно, но иногда можно восстановить удаленные запросы, вернувшись к ранее сохраненным версиям панели |
| [Рисунок 542](/image81.png) | Изменяет порядок запросов. Чтобы изменить порядок запросов, нажать и удерживать значок для перемещения, а затем переместить запросы в нужное место. Порядок результатов отражает порядок запросов, поэтому часто можно корректировать визуальные результаты в зависимости от порядка запросов |

## Добавление запроса

Чтобы просмотреть настройки для выбранного источника данных нужно нажать "Query options (Параметры запроса)" рядом с селектором источника данных. Изменения, которые вносится здесь, влияют только на запросы, созданные на этой панели (рисунок 44).

::sign-image
---
src: /image82.png
sign: Параметры запроса
---
::

Подсистема устанавливает значения по умолчанию, которые отображаются темно-серым текстом. Изменения отображаются белым текстом. Чтобы вернуть поле к настройкам по умолчанию, нужно удалить белый текст из поля.

Параметры запроса источника данных панели включают:

- Max data points (Максимальное количество точек данных) – если источник данных поддерживает эту функцию, то она устанавливает максимальное количество точек данных для каждого возвращаемого ряда. Если запрос возвращает больше точек данных, чем установлено максимальное количество точек данных, то источник данных уменьшает количество возвращаемых точек, объединяя их в среднее значение, максимальное значение или с помощью другой функции.

Чтобы повысить производительность запроса или сгладить визуализированную линию можно ограничить количество точек. Значение по умолчанию – это ширина (или количество пикселей) графика, поскольку можно визуализировать только столько точек данных, сколько помещается на панели графика.

При потоковой передаче данных Подсистема использует максимальное значение точек данных для прокручиваемого буфера. Потоковая передача – это непрерывный поток данных, а буферизация разделяет поток на фрагменты. Например, Loki транслирует данные в режиме реального времени.

- Min interval (Минимальный интервал) – устанавливает минимальное значение для автоматически рассчитываемого интервала, который обычно равен минимальному интервалу сбора данных. Если точка данных сохраняется каждые 15 секунд, не нужен будет интервал меньше этого значения. Также можно установить более высокий минимальный интервал, чем интервал сбора данных, чтобы получать более грубые и хорошо функционирующие запросы.

Следует обратить внимание, что Min interval (Минимальный интервал) соответствует минимальному шагу в Prometheus. Изменение интервала в Prometheus может изменить начало и конец диапазона запроса, поскольку Prometheus выравнивает диапазон по интервалу.

- Interval (Интервал) – задает временной интервал, который можно использовать при агрегации или группировки точек данных по времени.

Подсистема автоматически вычисляет соответствующий интервал, который можно использовать в качестве переменной в шаблонных запросах. Переменная измеряется либо в секундах ($ __interval), либо в миллисекундах ($__interval_ms).

Интервалы обычно используются в функциях агрегации, таких как sum или average. Например, это запрос Prometheus, который использует интервальную переменную:

```bash Terminal
rate(http_requests_total[$__interval])
```

Этот автоматический интервал рассчитывается на основе ширины графика. Когда пользователь уменьшает масштаб визуализации, интервал увеличивается, что приводит к более грубой агрегации. Аналогично, если пользователь увеличивает масштаб, интервал уменьшается, что приводит к более тонкой агрегации.

- Relative time (Относительное время) – переопределяет относительный диапазон времени для отдельных панелей, в результате чего они будут отличаться от того, что выбрано в средстве выбора времени на панели в правом верхнем углу панели. Это можно использовать, чтобы показывать метрики за разные периоды времени или дни на одной панели (таблица 46).

Переопределение времени панели не действует, если диапазон времени панели является абсолютным.

1. Относительное время

| **Пример** | **Поле относительного времени** |
| --- | --- |
| Последние 5 минут | now-5m |
| До этого дня | now/d |
| Последние 5 дней | now-5d/d |
| До этой недели | now/w |
| Последние 2 года | now-2y/y |

- Time shift (Сдвиг времени) – изменяет диапазон времени для отдельных панелей, смещая его начало и конец относительно выбора времени. Например, можно сдвинуть диапазон времени для панели на два часа раньше, чем выбрано время на панели мониторинга (таблица 47).

Переопределение времени панели не действует, если диапазон времени панели является абсолютным.

1. Сдвиг времени

| **Пример** | **Поле временного сдвига** |
| --- | --- |
| Всю прошлую неделю | 1w/w |
| Две полных недели назад | 2w/w |
| Весь последний месяц | 1M/M |
| Весь этот год | 1d/y |
| Весь прошлый год | 1y/y |

- Cache timeout (Тайм-аут кеша) – (доступно только в том случае, если доступно в источнике данных) переопределяет тайм-аут кеша по умолчанию, если в хранилище временных рядов есть кеш запросов; указывается в секундах.

## Управление запросами

В Подсистеме существуют общие для всех визуализаций настройки, которые задаются в секции "Panel options (Параметры панели)" на панели редактора. В следующих разделах описаны эти параметры, а также способы их настройки.

## Параметры запроса

Чтобы предоставить основную информацию о панели и определить базовые элементы отображения нужно задать параметры, указанные в таблице 48.

1. Параметры панели

| **Параметр** | **Описание** |
| --- | --- |
| Название | Текст, введенный в это поле, отображается в верхней части панели в редакторе панелей и на панели мониторинга. Возможно использовать определенные переменные в поле "Title (Заголовок)", но не глобальные переменные |
| Описание | Текст, введенный в это поле, отображается во всплывающей подсказке в левом верхнем углу панели. Можно добавить описание к панели, чтобы поделиться с пользователями важной информацией о ней, например о ее назначении. Возможно использовать определенные переменные в поле "Description (Описание)", но не глобальные переменные |
| Прозрачный фон | Включить и выключить этот переключатель, чтобы изменить цвет фона панели на тот же, что и у панели мониторинга |
| Ссылки на панели | Можно добавить ссылки на панель, чтобы создать ярлыки для других панелей мониторинга, панелей и внешних веб-сайтов. Чтобы получить доступ к ссылкам на панели, нужно нажать на значок рядом с названием панели |
| Повторные опции | Можно задать, следует ли повторять панель для каждого значения в выбранной переменной |
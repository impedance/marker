# Приложение Б. Протоколы

Запрос конфигурации пассивного Прокси "proxy config" отсылается Сервером, чтобы снабдить Прокси данными конфигурации. Этот запрос отсылается каждые ProxyConfigFrequency секунд (параметр конфигурации Сервера) (таблица 9).

1. Параметры запроса конфигурации

| Имя | Тип значения | Описание |
| --- | --- | --- |
| **Cервер→Прокси:** |
| `request` | `строка` | "`proxy config"` |
| `<таблица>` | `объект` | Один или более объектов с данными `<таблицы>.` |
|  | `fields` | `массив` | Массив имен полей. |
|  |  | `-` | `строка` | Имя поля. |
|  | `data` | `массив` | Массив строк. |
|  |  | `-` | `массив` | Массив столбцов. |
|  |  |  | `-` | `строка,число` | Значение столбца с типом, зависящим от типа столбца в схеме базы данных. |
| **Прокси→Cервер:** |
| `response` | `строка` | Информация об успешности запроса (`success `или `failed)`. |
| `version` | `строка` | Версия Прокси (`<major>.<minor>.<build>)`. |

Запрос данных пассивного Прокси "proxy data" используется для получения от Прокси данных о доступности интерфейсов узлов сети, а также данных истории, обнаружений и авторегистрации. Этот запрос отсылается каждые ProxyDataFrequency секунд (параметр конфигурации Сервера) (таблица 10).

1. Параметры запроса данных

| Имя | Тип значения | Описание |
| --- | --- | --- |
| **Cервер→Прокси:** |
| r`equest` | `строка` | "`proxy data"` |
| **Прокси→Cервер:** |
| s`ession` | `строка` | Токен сессии данных. |
| i`nterface availability` | `массив` | (опционально) Массив объектов данных о доступности интерфейсов. |
|  | `interfaceid` | `число` | Идентификатор интерфейса. |
|  | `available` | `число` | Доступность интерфейса:0, `INTERFACE_AVAILABLE_UNKNOWN `– неизвестно1, `INTERFACE_AVAILABLE_TRUE `– доступен2, `INTERFACE_AVAILABLE_FALSE `– недоступен |
|  | `error` | `строка` | Сообщение об ошибке интерфейса либо пустая строка. |
| h`istory data` | `массив` | (опционально) Массив объектов данных истории. |
|  | `itemid` | `число` | Идентификатор элемента данных. |
|  | `clock` | `число` | Отметка времени элемента данных (секунды). |
|  | `ns` | `число` | Отметка времени элемента данных (наносекунды). |
|  | `value` | `строка` | (опционально) Значение элемента данных. |
|  | `id` | `число` | Идентификатор значения (возрастающий счетчик, уникальный в пределах одной сессии данных). |
|  | `timestamp` | `число` | (опционально) Отметка времени (timestamp) элементов данных журнального типа. |
|  | `source` | `строка` | (опционально) Источник (source) элемента данных журнального типа. |
|  | `severity` | `число` | (опционально) Важность (severity) элемента данных журнального типа. |
|  | `eventid` | `число` | (опционально) Идентификатор (eventid) элемента данных журнального типа. |
|  | `state` | `строка` | (опционально) Состояние элемента данных:0, `ITEM_STATE_NORMAL`1, `ITEM_STATE_NOTSUPPORTED` |
|  | `lastlogsize` | `число` | (опционально) Последний размер файла журнала (lastlogsize) элемента данных журнального типа. |
|  | `mtime` | `число` | (опционально) Отметка времени последнего обновления (mtime) элемента данных журнального типа. |
| d`iscovery data` | `массив` | (опционально) Массив объектов данных обнаружения. |
|  | `clock` | `число` | Отметка времени данных обнаружения. |
|  | `druleid` | `число` | Идентификатор правила обнаружения. |
|  | `dcheckid` | `число` | Идентификатор проверки обнаружения или `null `для данных правила обнаружения. |
|  | `type` | `число` | Тип проверки обнаружения:-1 – данные проверки обнаружения0, `SVC_SSH `– проверка сервиса SSH1, `SVC_LDAP `– проверка сервиса LDAP2, `SVC_SMTP `– проверка сервиса SMTP3, `SVC_FTP `– проверка сервиса FTP4, `SVC_HTTP `– проверка сервиса HTTP5, `SVC_POP `– проверка сервиса POP6, `SVC_NNTP `– проверка сервиса NNTP7, `SVC_IMAP `– проверка сервиса IMAP8, `SVC_TCP `– проверка доступности порта TCP9, `SVC_AGENT `– Агент Подсистемы10, `SVC_SNMPv1 `– Агент SNMPv111, `SVC_SNMPv2 `– Агент SNMPv212, `SVC_ICMPPING `– пинг ICMP13, `SVC_SNMPv3 `– Агент SNMPv314, `SVC_HTTPS `– проверка сервиса HTTPS15, `SVC_TELNET `– проверка доступности Telnet |
|  | `ip` | `строка` | IP-адрес хоста. |
|  | `dns` | `строка` | DNS-имя хоста. |
|  | `port` | `число` | (опционально) Номер порта сервиса. |
|  | `key_` | `строка` | (опционально) Ключ элемента данных для проверок обнаружения с типом 9 `SVC_AGENT` |
|  | `value` | `строка` | (опционально) Полученное от сервиса значение, для большинства сервисов может быть пустым. |
|  | `status` | `число` | (опционально) Статус сервиса:0, `DOBJECT_STATUS_UP `– Сервис работает (UP)1, `DOBJECT_STATUS_DOWN `– Сервис не работает (DOWN) |
| a`uto registration` | `массив` | (опционально) Массив объектов данных авторегистрации. |
|  | `clock` | `число` | Отметка времени данных авторегистрации. |
|  | `host` | `строка` | Имя узла сети. |
|  | `ip` | `строка` | (опционально) IP-адрес узла сети. |
|  | `dns` | `строка` | (опционально) DNS-имя, отрезолвенное из IP-адреса. |
|  | `port` | `строка` | (опционально) Порт узла сети. |
|  | `host_metadata` | `строка` | (опционально) Метаданные узла сети, отосланные Агентом (на основе параметров конфигурации Агента `HostMetadata `или `HostMetadataItem)`. |
| t`asks` | `массив` | (опционально) Массив задач. |
|  | `type` | `число` | Тип задачи:0, `ZBX_TM_TASK_PROCESS_REMOTE_COMMAND_RESULT `– результат удаленной команды |
|  | `status` | `число` | Статус выполнения удаленной команды:0, `ZBX_TM_REMOTE_COMMAND_COMPLETED `– удаленная команда завершилась успешно1, `ZBX_TM_REMOTE_COMMAND_FAILED `– удаленная команда завершилась неудачно |
|  | `error` | `строка` | (опционально) Сообщение об ошибке. |
|  | `parent_taskid` | `число` | Идентификатор родительской задачи. |
| m`ore` | `число` | (опционально) 1 – имеются дополнительные данные истории для отправки. |
| c`lock` | `число` | (опционально) Отметка времени обмена данными (секунды). |
| n`s` | `число` | (опционально) Отметка времени обмена данными (наносекунды). |
| v`ersion` | `строка` | Версия Прокси (`<major>.<minor>.<build>)`. |
| C`ервер→Прокси:` |
| r`esponse` | `строка` | Информация об успешности запроса (success или failed). |
| t`asks` | `массив` | (опционально) Массив задач. |
|  | `type` | `число` | Тип задачи:1, `ZBX_TM_TASK_PROCESS_REMOTE_COMMAND `– удаленная команда |
|  | `clock` | `число` | Время создания задачи. |
|  | `ttl` | `число` | Время в секундах до истечения срока задачи. |
|  | `commandtype` | `число` | Тип удаленной задачи:0, `ZBX_SCRIPT_TYPE_CUSTOM_SCRIPT `– применить пользовательский скрипт1, `ZBX_SCRIPT_TYPE_IPMI `– использовать IPMI2, `ZBX_SCRIPT_TYPE_SSH `– использовать SSH3, `ZBX_SCRIPT_TYPE_TELNET `– использовать Telnet4, `ZBX_SCRIPT_TYPE_GLOBAL_SCRIPT `– использовать глобальный скрипт (в данный момент функционал эквивалентен пользовательскому скрипту) |
|  | `command` | `строка` | Команда для удаленного выполнения. |
|  | `execute_on` | `число` | Целевой объект выполнения для пользовательского скрипта:0, `ZBX_SCRIPT_EXECUTE_ON_AGENT `– выполнить скрипт на Агенте1, `ZBX_SCRIPT_EXECUTE_ON_SERVER `– выполнить скрипт на Сервере2, `ZBX_SCRIPT_EXECUTE_ON_PROXY `– выполнить скрипт на Прокси |
|  | `port` | `число` | (опционально) Порт для команд Telnet и SSH. |
|  | `authtype` | `число` | (опционально) Тип аутентификации для команд SSH. |
|  | `username` | `строка` | (опционально) Имя пользователя для команд Telnet и SSH. |
|  | `password` | `строка` | (опционально) Пароль для команд Telnet и SSH. |
|  | `publickey` | `строка` | (опционально) Открытый ключ (public key) для команд SSH. |
|  | `privatekey` | `строка` | (опционально) Закрытый ключ (private key) для команд SSH. |
|  | `parent_taskid` | `число` | Идентификатор родительской задачи. |
|  | `hostid` | `число` | Идентификатор целевого узла сети. |

- Активный Прокси

Контрольный запрос активного Прокси "proxy heartbeat" отсылается Прокси Сервером, чтобы сообщить, что он в рабочем состоянии. Этот запрос отсылается каждые HeartbeatFrequency секунд (параметр конфигурации Прокси) (таблица 11).

1. Параметры контрольного запроса

| Имя | Тип значения | Описание |
| --- | --- | --- |
| **Прокси→Cервер:** |
| r`equest` | `строка` | "`proxy heartbeat"` |
| h`ost` | `строка` | Имя Прокси-сервера. |
| v`ersion` | `строка` | Версия Прокси-сервера (`<major>.<minor>.<build>)`. |
| **Cервер→Прокси:** |
| r`esponse` | `строка` | Информация об успешности запроса (`success `или `failed)`. |

Запрос конфигурации активного Прокси "proxy config" отсылается Прокси Сервером для получения его конфигурационных данных. Этот запрос отсылается каждые ConfigFrequency секунд (параметр конфигурации Прокси) (таблица 12).

1. Параметры запроса конфигурации

| Имя | Тип значения | Описание |
| --- | --- | --- |
| **Прокси→Cервер:** |
| r`equest` | `строка` | "`proxy config"` |
| h`ost` | `строка` | Имя Прокси-сервера. |
| v`ersion` | `строка` | Версия Прокси-сервера (`<major>.<minor>.<build>)`. |
| **Cервер→Прокси:** |
| r`equest` | `строка` | "`proxy config"` |
| <`таблица>` | `объект` | Один или более объектов с данными `<таблицы>.` |
|  | `fields` | `массив` | Массив имен полей. |
|  |  | `-` | `строка` | Имя поля. |
|  | `data` | `массив` | Массив строк. |
|  |  | - | `массив` | Массив столбцов. |
|  |  |  | - | `строка,число` | Значение столбца с типом, зависящим от типа столбца в схеме базы данных. |
| **Прокси→Cервер:** |
| r`esponse` | `строка` | Информация об успешности запроса (`success `или `failed)`. |

Запрос на передачу данных активного Прокси "proxy data" отсылается Прокси Сервером, чтобы предоставить данные о доступности интерфейсов узлов сети, а также данных истории, обнаружений и авторегистрации. Этот запрос отсылается каждые DataSenderFrequency секунд (параметр конфигурации Прокси). Следует обратить внимание, что активный Прокси будет опрашивать Сервер каждую секунду относительно задач на удаленное выполнение (с пустым запросом "proxy data") (таблица 13).

1. Параметры запроса на передачу

| Имя | Тип значения | Описание |
| --- | --- | --- |
| **Прокси→Cервер:** |
| r`equest` | `строка` | "`proxy data"` |
| h`ost` | `строка` | Имя Прокси Сервера. |
| s`ession` | `строка` | Токен сессии данных. |
| i`nterface availability` | `массив` | (опционально) Массив объектов данных о доступности интерфейсов. |
|  | `interfaceid` | `число` | Идентификатор интерфейса. |
|  | `available` | `число` | Доступность интерфейса:0, `INTERFACE_AVAILABLE_UNKNOWN `– неизвестно1, `INTERFACE_AVAILABLE_TRUE `– доступен2, `INTERFACE_AVAILABLE_FALSE `– недоступен |
|  | `error` | `строка` | Сообщение об ошибке интерфейса либо пустая строка. |
| h`istory data` | `массив` | (опционально) Массив объектов данных истории. |
|  | `itemid` | `число` | Идентификатор элемента данных. |
|  | `clock` | `число` | Отметка времени элемента данных (секунды). |
|  | `ns` | `число` | Отметка времени элемента данных (наносекунды). |
|  | `value` | `строка` | (опционально) Значение элемента данных. |
|  | `id` | `число` | Идентификатор значения (возрастающий счетчик, уникальный в пределах одной сессии данных). |
|  | `timestamp` | `число` | (опционально) Отметка времени (timestamp) элементов данных журнального типа. |
|  | `source` | `строка` | (опционально) Источник (source) элемента данных журнального типа. |
|  | `severity` | `число` | (опционально) Важность (severity) элемента данных журнального типа. |
|  | `eventid` | `число` | (опционально) Идентификатор (eventid) элемента данных журнального типа. |
|  | `state` | `строка` | (опционально) Состояние элемента данных:0, `ITEM_STATE_NORMAL`1, `ITEM_STATE_NOTSUPPORTED` |
|  | `lastlogsize` | `число` | (опционально) Последний размер файла журнала (lastlogsize) элемента данных журнального типа. |
|  | `mtime` | `число` | (опционально) Отметка времени последнего обновления (mtime) элемента данных журнального типа. |
| d`iscovery data` | `массив` | (опционально) Массив объектов данных обнаружения. |
|  | `clock` | `число` | Отметка времени данных обнаружения. |
|  | `druleid` | `число` | Идентификатор правила обнаружения. |
|  | `dcheckid` | `число` | Идентификатор проверки обнаружения или `null `для данных правила обнаружения. |
|  | `type` | `число` | Тип проверки обнаружения:-1 – данные проверки обнаружения0, `SVC_SSH `– проверка сервиса SSH1, `SVC_LDAP `– проверка сервиса LDAP2, `SVC_SMTP `– проверка сервиса SMTP3, `SVC_FTP `– проверка сервиса FTP4, `SVC_HTTP `– проверка сервиса HTTP5, `SVC_POP `– проверка сервиса POP6, `SVC_NNTP `– проверка сервиса NNTP7, `SVC_IMAP `– проверка сервиса IMAP8, `SVC_TCP `– проверка доступности порта TCP9, `SVC_AGENT `– Агент Подсистемы10, `SVC_SNMPv1 `– Агент SNMPv111, `SVC_SNMPv2 `– Агент SNMPv212, `SVC_ICMPPING `– пинг ICMP13, `SVC_SNMPv3 `– Агент SNMPv314, `SVC_HTTPS `– проверка сервиса HTTPS15, `SVC_TELNET `– проверка доступности Telnet |
|  | `ip` | `строка` | IP-адрес хоста. |
|  | `dns` | `строка` | DNS-имя хоста. |
|  | `port` | `число` | (опционально) Номер порта сервиса. |
|  | `key_` | `строка` | (опционально) Ключ элемента данных для проверок обнаружения с типом 9 `SVC_AGENT` |
|  | `value` | `строка` | (опционально) Полученное от сервиса значение, для большинства сервисов может быть пустым. |
|  | `status` | `число` | (опционально) Статус сервиса:0, `DOBJECT_STATUS_UP `– Сервис работает (UP)1, `DOBJECT_STATUS_DOWN `– Сервис не работает (DOWN) |
| a`utoregistration` | `массив` | (опционально) Массив объектов данных авторегистрации. |
|  | `clock` | `число` | Отметка времени данных авторегистрации. |
|  | `host` | `строка` | Имя узла сети. |
|  | `ip` | `строка` | (опционально) IP-адрес узла сети. |
|  | `dns` | `строка` | (опционально) DNS-имя, отрезолвенное из IP-адреса. |
|  | `port` | `строка` | (опционально) Порт узла сети. |
|  | `host_metadata` | `строка` | (опционально) Метаданные узла сети, отосланные Агентом (на основе параметров конфигурации Агента `HostMetadata `или `HostMetadataItem)`. |
| t`asks` | `массив` | (опционально) Массив задач. |
|  | `type` | `число` | Тип задачи:0, `ZBX_TM_TASK_PROCESS_REMOTE_COMMAND_RESULT `– результат удаленной команды |
|  | `status` | `число` | Статус выполнения удаленной команды:0, `ZBX_TM_REMOTE_COMMAND_COMPLETED `– удаленная команда завершилась успешно1, `ZBX_TM_REMOTE_COMMAND_FAILED `– удаленная команда завершилась неудачно |
|  | `error` | `строка` | (опционально) Сообщение об ошибке. |
|  | `parent_taskid` | `число` | Идентификатор родительской задачи. |
| m`ore` | `число` | (опционально) 1 – имеются дополнительные данные истории для отправки. |
| c`lock` | `число` | (опционально) Отметка времени обмена данными (секунды). |
| n`s` | `число` | (опционально) Отметка времени обмена данными (наносекунды). |
| v`ersion` | `строка` | Версия Прокси Сервера (`<major>.<minor>.<build>)`. |
| **Cервер→Прокси:** |
| response | `строка` | Информация об успешности запроса (`success `или `failed)`. |
| upload | `строка` | Управление загрузкой для исторических данных (история, авторегистрация, доступность узлов сети, сетевое обнаружение).Возможные значения:`– enabled `– нормальная работа; – `disabled `– Сервер не принимает данные (возможно, из-за превышения ограничения внутреннего кэша). |
| tasks | `массив` | (опционально) Массив задач. |
|  | type | `число` | Тип задачи:1, `ZBX_TM_TASK_PROCESS_REMOTE_COMMAND `– удаленная команда |
|  | clock | `число` | Время создания задачи. |
|  | ttl | `число` | Время в секундах до истечения срока задачи. |
|  | commandtype | `число` | Тип удаленной задачи:0, `ZBX_SCRIPT_TYPE_CUSTOM_SCRIPT `– применить пользовательский скрипт1, `ZBX_SCRIPT_TYPE_IPMI `– использовать IPMI2, `ZBX_SCRIPT_TYPE_SSH `– использовать SSH3, `ZBX_SCRIPT_TYPE_TELNET `– использовать Telnet4, `ZBX_SCRIPT_TYPE_GLOBAL_SCRIPT `– использовать глобальный скрипт (в данный момент функционал эквивалентен пользовательскому скрипту) |
|  | command | `строка` | Команда для удаленного выполнения. |
|  | execute_on | `число` | Целевой объект выполнения для пользовательского скрипта:0, `ZBX_SCRIPT_EXECUTE_ON_AGENT `– выполнить скрипт на Агенте1, `ZBX_SCRIPT_EXECUTE_ON_SERVER `– выполнить скрипт на Сервере2, `ZBX_SCRIPT_EXECUTE_ON_PROXY `– выполнить скрипт на Прокси |
|  | port | `число` | (опционально) Порт для команд Telnet и SSH. |
|  | authtype | `число` | (опционально) Тип аутентификации для команд SSH. |
|  | username | `строка` | (опционально) Имя пользователя для команд Telnet и SSH. |
|  | password | `строка` | (опционально) Пароль для команд Telnet и SSH. |
|  | publickey | `строка` | (опционально) Открытый ключ (public key) для команд SSH. |
|  | privatekey | `строка` | (опционально) Закрытый ключ (private key) для команд SSH. |
|  | parent_taskid | `число` | Идентификатор родительской задачи. |
|  | hostid | `число` | Идентификатор целевого узла сети. |

# Б.1 Протокол обмена данными между Сервером и Прокси

Для получения более подробной информации следует обратиться к п.Г.3.

# Б.2 Пассивный Прокси

В этом разделе представлена информация о запросах и ответах Агента-2:

- "Агент-2  Сервер" – запрос на активную проверку;
- "Сервер  Агент-2" – ответ активной проверки;
- "Агент-2  Сервер" – запрос данных Агента;
- "Сервер  Агент-2" – ответ на данные Агента.

Запрос на активную проверку используется для получения активных проверок для последующей обработки Агентом. Запрос посылается Агентом при старте и затем с интервалом RefreshActiveChecks (таблица 14).

1. Параметры запросов на активную проверку

| Поле | Тип | Обязательное | Значение |
| --- | --- | --- | --- |
| r`equest` | `строка` | да | `active checks` |
| h`ost` | `строка` | да | Имя узла сети. |
| v`ersion` | `строка` | да | Версия Агента: `<major>.<minor>.` |
| h`ost_metadata` | `строка` | нет | Параметр конфигурации `HostMetadata `или значение метрики `HostMetadataItem.` |
| i`nterface` | `строка` | нет | Параметр конфигурации `HostInterface `или значение метрики `HostInterfaceItem.` |
| i`p` | `строка` | нет | Первый IP параметра конфигурации `LISTENIP,` если задан. |
| p`ort` | `число` | нет | Значение параметра конфигурации `LISTENPort,` если задано и отличается от порта Агента по умолчанию. |

Ответ активных проверок отсылается Сервером обратно Агенту после обработки запроса на активные проверки (таблица 15).

1. Параметры ответа активные проверок

| Поле | Тип | Обязательное | Значение |
| --- | --- | --- | --- |
| r`esponse` | `строка` | да | `success `\| `failed` |
| i`nfo` | `строка` | нет | Информация об ошибке в случае сбоя. |
| d`ata` | `массив объектов` | нет | Активные проверки элементов данных. |
|  | `key` | `строка` | нет | Ключ элемента данных с раскрытыми макросами. |
|  | `itemid` | `число` | нет | Идентификатор элемента данных. |
|  | `delay` | `строка` | нет | Интервал обновления элемента данных. |
|  | `lastlogsize` | `число` | нет | Последний размер файла журнала (lastlogsize) элемента данных. |
|  | `mtime` | `число` | нет | Отметка времени последней модификации (mtime) элемента данных. |
| r`egexp` | `массив объектов` | нет | Глобальные регулярные выражения. |
|  | `name` | `строка` | нет | Имя глобального регулярного выражения. |
|  | `expression` | `строка` | нет | Глобальное регулярное выражение. |
|  | `expression_type` | `число` | нет | Тип глобального регулярного выражения. |
|  | `exp_delimiter` | `строка` | нет | Разделитель глобального регулярного выражения. |
|  | `case_sensitive` | `число` | нет | Флаг чувствительности к регистру глобального регулярного выражения. |

Запрос данных Агента содержит собранные значения элементов данных (таблица 16).

1. Параметры запроса данных

| Поле | Тип | Обязательное | Значение |
| --- | --- | --- | --- |
| r`equest` | `строка` | да | `agent data` |
| h`ost` | `строка` | да | Имя узла сети. |
| v`ersion` | `строка` | да | Версия Агента: `<major>.<minor>.` |
| s`ession` | `строка` | да | Уникальный идентификатор сессии, генерируется каждый раз при старте Агента. |
| d`ata` | `массив объектов` | да | Значения элементов данных. |
|  | `id` | `число` | да | Идентификатор значения (возрастающий счетчик, используемый для контроля дублированных значений в случае сетевых проблем). |
|  | `itemid` | `число` | да | Идентификатор элемента данных. |
|  | `value` | `строка` | нет | Значение элемента данных. |
|  | `lastlogsize` | `число` | нет | Последний размер файла журнала (lastlogsize) элемента данных. |
|  | `mtime` | `число` | нет | Отметка времени последнего обновления (mtime) элемента данных. |
|  | `state` | `число` | нет | Состояние элемента данных. |
|  | `source` | `строка` | нет | Источник (source) значения журнала событий. |
|  | `eventid` | `число` | нет | Идентификатор (eventid) значения журнала событий. |
|  | `severity` | `число` | нет | Важность (severity) значения журнала событий. |
|  | `timestamp` | `число` | нет | Отметка времени (timestamp) значения журнала событий. |
|  | `clock` | `число` | да | Отметка времени значения (секунд с начала эпохи). |
|  | `ns` | `число` | да | Наносекунды отметки времени значения. |

Ответ на данные Агента отсылается Сервером назад Агенту после обработки запроса данных Агента (таблица 17).

1. Параметра ответы на данные

| Поле | Тип | Обязательное | Значение |
| --- | --- | --- | --- |
| r`esponse` | `строка` | да | `success `\| `failed` |
| i`nfo` | `строка` | да | Результаты обработки элементов данных. |
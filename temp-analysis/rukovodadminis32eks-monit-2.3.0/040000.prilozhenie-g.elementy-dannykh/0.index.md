# Приложение Г. Элементы данных

Активные проверки требуют более сложной обработки. Агент сначала должен получить с Сервера (или Серверов) список элементов данных для независимой обработки.

Серверы для получения активных проверок перечислены в параметре ServerActive файла конфигурации Агента. Частота запросов данных проверок настраивается параметром RefreshActiveChecks в этом же файле конфигурации. Если обновление активных проверок завершится с ошибкой, запрос повторится через 60 секунд (задано в коде).

Затем Агент периодически отправляет новые значения на Сервер(ы).

Если Агент находится за брандмауэром, можно рассмотреть возможность использования исключительно активных проверок, т.к. в этом случае не понадобится менять настройки брандмауэра для разрешения начальных входящих соединений.

# Г.1 Поддерживаемые элементы данных по платформам

Запрос на активные проверки используется для получения списка активных проверок, обрабатываемых Агентом. Этот запрос отсылается Агентом после старта и затем с интервалом RefreshActiveChecks (таблица 37).

1. Поля запроса активных проверок

| Поле | Тип | Обязательный | Значение |
| --- | --- | --- | --- |
| r`equest` | `строка` | да | `active checks` |
| h`ost` | `строка` | да | Имя узла сети. |
| h`ost_metadata` | `строка` | нет | Значение метрики параметра конфигурации `HostMetadata `или `HostMetadataItem.` |
| H`ostInterface` | `строка` | нет | Значение метрики параметра конфигурации `HostInterface `или `HostInterfaceItem.` |
| i`p` | `строка` | нет | Первый IP параметра конфигурации `LISTENIP,` если задан. |
| p`ort` | `число` | нет | Значение параметра конфигурации `LISTENPort,` если задано и не является портом, прослушиваемым Агентом по умолчанию. |

Ответ активных проверок посылается Сервером обратно Агенту после обработки запроса на активные проверки (таблица 38).

1. Поля ответа активных проверок

| Поле | Тип | Обязательный | Значение |
| --- | --- | --- | --- |
| r`esponse` | `строка` | да | `success `\| `failed` |
| i`nfo` | `строка` | нет | Сообщение об ошибке в случае сбоя. |
| d`ata` | `массив объектов` | нет | Элементы данных для активных проверок. |
|  | `key` | `строка` | нет | Ключ элемента данных с раскрытыми макросами. |
|  | `key_orig` | `строка` | нет | Ключ элемента данных с нераскрытыми макросами. |
|  | `itemid` | `число` | нет | Идентификатор элемента данных. |
|  | `delay` | `строка` | нет | Интервал обновления элемента данных. |
|  | `lastlogsize` | `число` | нет | Последний размер файла журнала (lastlogsize) элемента данных. |
|  | `mtime` | `число` | нет | Отметка времени последнего обновления (mtime) элемента данных. |
| r`efresh_unsupported` | `число` | нет | Интервал обновления неподдерживаемого элемента данных. |
| r`egexp` | `массив объектов` | нет | Глобальные регулярные выражения. |
|  | `name` | `строка` | нет | Имя глобального регулярного выражения. |
|  | `expression` | `строка` | нет | Глобальное регулярное выражение. |
|  | `expression_type` | `число` | нет | Тип глобального регулярного выражения. |
|  | `exp_delimiter` | `строка` | нет | Разделитель глобального регулярного выражения. |
|  | `case_sensitive` | `число` | нет | Признак чувствительности к регистру глобального регулярного выражения. |

Сервер должен ответить успешно, например:

1. Агент открывает TCP-соединение;
2. Агент запрашивает список проверок;
3. Сервер отвечает списком элементов данных (ключ элемента данных, интервал обновления);
4. Агент анализирует ответ;
5. TCP-соединение закрывается;
6. Агент начинает периодический сбор данных.

> Примечание – Следует обратить внимание, что при использовании активных проверок (чувствительные) данные конфигурации могут стать доступными лицам, имеющим доступ к порту траппера Сервера. Это возможно, так как любой пользователь может представиться активным Агентом и запросить данные конфигурации элементов данных; аутентификация не производится, если только не используются опции шифрования.

# Г.2 Параметры vm.memory.size

Запрос Агента с данными содержит собранные значения элементов данных (таблица 39).

1. Поля собранных данных

| Поле | Тип | Обязательный | Значение |
| --- | --- | --- | --- |
| r`equest` | `строка` | да | "a`gent data"` |
| s`ession` | `строка` | да | Уникальный идентификатор сессии, генерируемый каждый раз при старте Агента. |
| d`ata` | `массив объектов` | да | Значения элементов данных. |
|  | `id` | `число` | да | Идентификатор значения (возрастающий счетчик, используемый для проверки дубликатов значений в случае сетевых проблем). |
|  | `host` | `строка` | да | Имя узла сети. |
|  | `key` | `строка` | да | Ключ элемента данных. |
|  | `value` | `строка` | нет | Значение элемента данных. |
|  | `lastlogsize` | `число` | нет | Последний размер журнала (lastlogsize) элемента данных. |
|  | `mtime` | `число` | нет | Отметка времени последнего обновления (mtime) элемента данных. |
|  | `state` | `число` | нет | Состояние элемента данных. |
|  | `source` | `строка` | нет | Источник (source) значения журнала событий. |
|  | `eventid` | `число` | нет | Идентификатор (eventid) значения журнала событий. |
|  | `severity` | `число` | нет | Важность (severity) значения журнала событий. |
|  | `timestamp` | `число` | нет | Отметка времени (timestamp) значения журнала событий. |
|  | `clock` | `число` | да | Отметка времени значения (секунд с начала эпохи). |
|  | `ns` | `число` | да | Наносекунды отметки времени значения. |

Каждому значению назначается виртуальный ID. Значение ID – простой возрастающий счетчик, уникальный в пределах одной сессии данных (идентифицируемой токеном сессии). Этот ID используется, чтобы отбрасывать дубликаты значений, которые могли быть отосланы в средах с плохой связью.

Ответ на данные Агента отсылается Сервером назад Агенту после обработки запроса Агента с данными (таблица 40).

1. Поля ответа на данные

| Поле | Тип | Обязательный | Значение |
| --- | --- | --- | --- |
| r`esponse` | `строка` | да | `success `\| `failed` |
| i`nfo` | `строка` | да | Результаты обработки элементов данных. |

Если отправка некоторых значений завершилась неудачей на Сервере (например, по причине того, что узел сети или элемент данных был деактивирован или удален), Агент не будет повторять отправку этих элементов данных, например:

1. Агент открывает TCP-соединение;
2. Агент отправляет список значений;
3. сервер обрабатывает данные и отправляет обратно статус;
4. TCP-соединение закрывается.

Следует обратить внимание на то, как в примере выше указывается неподдерживаемое состояние для vfs.fs.size[/nono] при помощи значения state, равного "1", и сообщения об ошибке в свойстве value.

Сообщение об ошибке будет обрезано до 2048 символов на стороне Сервера.

# Г.3 Пассивные и активные проверки Агентов

При использовании Подсистемы можно воспользоваться получением метрик с хоста, на котором установлен Агент. Чтобы использовать принцип минимальных привилегий, необходимо определить метрики, которые собираются Агентом.

Таблицы 41-42 позволят выбрать минимальные права, которые будут гарантировать корректную работу Агента.

Если для работы Агента выбран пользователь, отличный от LocalSystem, то для работы Агента в качестве службы Windows новый пользователь должен иметь права "Вход в качестве службы" из меню панели навигации "Групповая политика → Назначение прав пользователя" и право создавать, записывать и удалять файл журнала Агента. Пользователь Active Directory должен быть добавлен в группу "Performance Monitor Users".

При работе с правами Агента, основываясь на группе "Минимально технически приемлемо", требуется предварительное предоставление прав на объекты мониторинга.

1. Основные элементы данных Агента, поддерживаемые в Windows

| Ключ элемента данных | Группа пользователей |
| --- | --- |
|  | **Рекомендуется** | **Минимально технически приемлемо (ограниченные возможности)** |
| a`gent.Hostname` | `Г`ости | Гости |
| a`gent.ping` | `Г`ости | Гости |
| a`gent.variant` | `Г`ости | Гости |
| a`gent.version` | `Г`ости | Гости |
| l`og` | `А`дминистраторы | Гости |
| l`og.count` | `А`дминистраторы | Гости |
| l`ogrt` | `А`дминистраторы | Гости |
| l`ogrt.count` | `А`дминистраторы | Гости |
| n`et.dns` | `Г`ости | Гости |
| n`et.dns.record` | `Г`ости | Гости |
| n`et.if.discovery` | `Г`ости | Гости |
| n`et.if.in` | `Г`ости | Гости |
| n`et.if.out` | `Г`ости | Гости |
| n`et.if.total` | `Г`ости | Гости |
| n`et.tcp.LISTEN` | `Г`ости | Гости |
| n`et.tcp.port` | `Г`ости | Гости |
| n`et.tcp.service` | `Г`ости | Гости |
| n`et.tcp.service.perf` | `Г`ости | Гости |
| n`et.udp.service` | `Г`ости | Гости |
| n`et.udp.service.perf` | `Г`ости | Гости |
| p`roc.num` | `А`дминистраторы | Гости |
| s`ystem.cpu.discovery` | `П`ользователи монитора производительности | Пользователи монитора производительности |
| s`ystem.cpu.load` | `П`ользователи монитора производительности | Пользователи монитора производительности |
| s`ystem.cpu.num` | `Г`ости | Гости |
| s`ystem.cpu.util` | `П`ользователи монитора производительности | Пользователи монитора производительности |
| s`ystem.Hostname` | `Г`ости | Гости |
| s`ystem.localtime` | `Г`ости | Гости |
| s`ystem.run` | `А`дминистраторы | Гости |
| s`ystem.sw.arch` | `Г`ости | Гости |
| s`ystem.swap.size` | `Г`ости | Гости |
| s`ystem.uname` | `Г`ости | Гости |
| s`ystem.uptime` | `П`ользователи монитора производительности | Пользователи монитора производительности |
| v`fs.dir.count` | `А`дминистраторы | Гости |
| v`fs.dir.get` | `А`дминистраторы | Гости |
| v`fs.dir.size` | `А`дминистраторы | Гости |
| v`fs.file.cksum` | `А`дминистраторы | Гости |
| v`fs.file.contents` | `А`дминистраторы | Гости |
| v`fs.file.exists` | `А`дминистраторы | Гости |
| v`fs.file.md5sum` | `А`дминистраторы | Гости |
| v`fs.file.regexp` | `А`дминистраторы | Гости |
| v`fs.file.regmatch` | `А`дминистраторы | Гости |
| v`fs.file.size` | `А`дминистраторы | Гости |
| v`fs.file.time` | `А`дминистраторы | Гости |
| v`fs.fs.discovery` | `А`дминистраторы | Гости |
| v`fs.fs.size` | `А`дминистраторы | Гости |
| v`m.memory.size` | `Г`ости | Гости |
| w`eb.page.get` | `Г`ости | Гости |
| w`eb.page.perf` | `Г`ости | Гости |
| w`eb.page.regexp` | `Г`ости | Гости |
| z`abbix.stats` | `Г`ости | Гости |

1. Ключи элементов данных, специфичные для Windows

| Ключ элемента данных | Группа пользователей |
| --- | --- |
|  | **Рекомендуется** | **Минимально технически приемлемо (ограниченные возможности)** |
| e`ventlog` | `Ч`итатели журнала событий | Гости |
| n`et.if.list` | `Г`ости | Гости |
| p`erf_counter` | `П`ользователи монитора производительности | Пользователи монитора производительности |
| p`roc_info` | `А`дминистраторы | Гости |
| s`ervice.discovery` | `Г`ости | Гости |
| s`ervice.info` | `Г`ости | Гости |
| s`ervices` | `Г`ости | Гости |
| w`mi.get` | `А`дминистраторы | Гости |
| v`m.vmemory.size` | `Г`ости | Гости |

# Г.3.2.1 Пассивные проверки

Сервер ожидает, что каждое получаемое текстовое значение будет в кодировке UTF-8. Это относится к любому типу проверок: Агент, ssh, telnet и т.д.

Различные системы/устройства и проверки могут возвращать в значениях non-ASCII символы. Для таких случаев почти все доступные в Подсистеме ключи имеют дополнительный параметр ключа элемента данных <кодировка>. Этот параметр ключа необязателен, но он должен быть указан, если получаемое значение не в кодировке UTF-8 и содержит non-ASCII символы. Иначе результат может быть неожиданным и непредсказуемым.

Описание поведения различных БД в этих случаях:

- MySQL – если значение содержит non-ASCII символ в не UTF-8-кодировке, то этот символ и следующий за ним символ будут отброшены при записи этого значения базой данных. Никакие предупреждающие сообщения не записываются в zabbix_server.log;
- PostgreSQL – если значение содержит non-ASCII символ в не UTF-8-кодировке, то это приведет к ошибке в SQL-запросе (`PGRES_FATAL_ERROR:ERROR invalid Byte sequence for encoding)`, и данные не будут записаны. Соответствующее сообщение с предупреждением будет записано в zabbix_server.log.

# Г.3.2.2 Активные проверки

Поддержка больших файлов (Large file support, сокращенно – LFS) – это термин, применяемый к возможности работать с файлами больше чем 2ГБ на 32-битных операционных системах. Это на мониторинг файлов журналов и на все элементы данных vfs.file.*. Поддержка больших файлов зависит от возможностей системы во время компиляции Подсистемы, но поддержка полностью отключена для 32-битных систем Solaris по причине несовместимости с procfs и swapctl.
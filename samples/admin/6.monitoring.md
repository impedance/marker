---
title: Мониторинг и диагностика

readPrev:
  to: /developer/administrator/setup-os
  label: Тонкая настройка операционной системы

readNext:
  to: /developer/administrator/winter-cms
  label: Управление контентом через Winter CMS
---

# Мониторинг и диагностика

Для обеспечения бесперебойной работы Портала разработчика требуется соблюдать ряд мер по мониторингу и диагностике.
Администратору Комплекса следует своевременно выявлять отклонения в работе служб, предотвращать потерю данных и
оперативно реагировать на сбои.

В данной главе приведены рекомендации по обеспечению устойчивого функционирования Комплекса, включая правила
хранения постоянных данных, создание резервных копий и настройку системы мониторинга.

## 6.1 Расположение программного обеспечения и журналов событий

Поскольку работа Комплекса развёрнута в изолированных контейнерах `Docker`,
для мониторинга состояния компонентов и выявления сбоев реализовано централизованное логирование через
стандартный поток вывода (`stdout`) каждого контейнера.
Это позволяет фиксировать события выполнения и обеспечивать оперативный доступ к журналам.

Для получения информации о состоянии запущенных контейнеров и анализа логов используются стандартные команды `Docker`.
В таблице 9 приведён перечень типовых команд и описание их выводов.

<div class="joplin-table-wrapper">
    <table>
        <thead>
            <tr>
                <th>
                    <p>Команда Docker</p>
                </th>
                <th>
                    <p>Назначение</p>
                </th>
                <th>
                    <p>Описание вывода</p>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <p>docker ps</p>
                </td>
                <td>
                    <p>Выводит список всех запущенных контейнеров Docker</p>
                </td>
                <td rowspan="6">
                    <p>Выводы (по умолчанию):</p>
                    <ul>
                        <li>CONTAINER ID: Уникальный идентификатор контейнера (хеш);</li>
                        <li>IMAGE: Имя образа, из которого был создан контейнер;</li>
                        <li>COMMAND: Команда, которая выполняется внутри контейнера;</li>
                        <li>CREATED: Время, прошедшее с момента создания контейнера.</li>
                        <li>STATUS: Текущий статус контейнера (например, “Up 5 seconds”, “Exited (0) 2 hours ago”).</li>
                        <li>PORTS: Опубликованные порты (если есть)</li>
                    </ul>
                    <p>NAMES: Имя контейнера (заданное пользователем или сгенерированное Docker)</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps -a или docker ps --all</p>
                </td>
                <td>
                    <p>Выводит список всех контейнеров, включая остановленные</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps -l или docker ps --latest</p>
                </td>
                <td>
                    <p>Показывает только последний созданный контейнер (запущен или нет)</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps -q</p>
                </td>
                <td>
                    <p>Выводит только идентификаторы контейнеров</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps -n [число]</p>
                </td>
                <td>
                    <p>Показывает информацию о последних N созданных контейнерах</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps -s</p>
                </td>
                <td>
                    <p>Выводит размеры контейнеров</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker inspect</p>
                </td>
                <td>
                    <p>Отображает подробную информацию о контейнере</p>
                </td>
                <td>
                    <p>Вывод будет в формате JSON и содержать подробные сведения о контейнере:</p>
                    <ul>
                        <li>ID: ID контейнера;</li>
                        <li>Name: имя контейнера;</li>
                        <li>Image: ID образа;</li>
                        <li>Config: конфигурация контейнера (команда, переменные окружения, порты и т.д.);</li>
                        <li>State: текущее состояние контейнера (статус, запущен или нет, код выхода и т.д.). Ключевое
                            поле Status здесь показывает текущий статус;</li>
                        <li>NetworkSettings: настройки сети (IP-адреса, порты и т.д.);</li>
                        <li>Mounts: информация о примонтированных томах (volumes) и дополнительная информация</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker logs</p>
                </td>
                <td>
                    <p>Просматривает журналы контейнера</p>
                </td>
                <td>
                    <p>Формат логов внутри контейнера определяется самим приложением. Docker logs просто извлекает этот
                        вывод</p>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker events</p>
                </td>
                <td>
                    <p>Просматривает события Docker, включая изменения состояния контейнеров.</p>
                </td>
                <td>
                    <p>Формат вывода по умолчанию:</p>
                    <ul>
                        <li>time: время события (Unix timestamp).</li>
                        <li>timeNano: время события в наносекундах.</li>
                        <li>status: тип события (например: start, stop, create, destroy).</li>
                        <li>id: ID объекта, к которому относится событие (например, ID контейнера или ID образа).</li>
                        <li>from: имя образа (если событие связано с образом).</li>
                        <li>Type: тип ресурса, к которому относится событие (например, container, image, network).</li>
                        <li>Action: действие, которое произошло (например: start, stop, create, destroy);</li>
                        <li>Actor: объект, который является источником события;</li>
                        <li>scope: область действия события (local или swarm)</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps --format</p>
                </td>
                <td>
                    <p>Позволяет настроить формат вывода. Выводит только выбранную информацию, например, ID и имена
                        контейнеров</p>
                </td>
                <td>
                    <p>Формат вывода определяется шаблоном, указанным в кавычках после --format.</p>
                    <p>Основные доступные поля:</p>
                    <ul>
                        <li>.ID: ID контейнера.</li>
                        <li>.Image: имя образа.</li>
                        <li>.Command: команда, выполняющаяся внутри контейнера.</li>
                        <li>.CreatedAt: время создания контейнера (в формате RFC3339).</li>
                        <li>.RunningFor: время, в течение которого контейнер работает (например, 2 minutes ago).</li>
                        <li>.Ports: опубликованные порты.</li>
                        <li>.Names: имена контейнеров.</li>
                        <li>.Labels: метки (labels) контейнера.</li>
                        <li>.Mounts: информация о примонтированных томах.</li>
                        <li>.State: текущее состояние контейнера (например, running, exited).</li>
                        <li>.Status: статус контейнера (например, Up 5 seconds, Exited (0) 2 hours ago).</li>
                        <li>.Size: размер контейнера (с дисками и без дисков)</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>docker ps --filter</p>
                </td>
                <td>
                    <p>Фильтрует вывод по определенным критериям.</p>
                </td>
                <td>
                    <p>Формат вывода идентичен стандартному формату docker ps (или тому, который задан с помощью
                        --format), но отображаются только контейнеры, удовлетворяющие условиям фильтра.</p>
                    <p>Колонки:</p>
                    <ul>
                        <li>CONTAINER ID;</li>
                        <li>IMAGE;</li>
                        <li>COMMAND;</li>
                        <li>CREATED;</li>
                        <li>STATUS;</li>
                        <li>PORTS, NAMES</li>
                    </ul>
                </td>
            </tr>
        </tbody>
    </table>
</div>

> Таблица 9 – Типовые команды управления контейнерами Docker

## 6.2 Хранение постоянных данных

Для обеспечения сохранности данных при перезапуске, обновлении или удалении контейнеров используется механизм томов
`Docker` (`Docker volumes`). Эти тома создаются при первоначальной установке Комплекса
([см. раздел 4.1.4](/developer/administrator/install-and-launch#_414-подготовка-постоянного-хранилища)).
В рамках мониторинга и диагностики важно отслеживать их текущее состояние, объем занятого пространства,
а также корректность подключения к контейнерам. Повреждение данных в этих томах может привести к полной или
частичной недоступности функций Комплекса.

Для диагностики постоянных хранилищ необходимо понимать правильное назначение томов в Комплексе.
Их перечень с описанием представлен в таблице 10.

| Название тома  | Назначение                                                                              |
| -------------- | --------------------------------------------------------------------------------------- |
| code           | Хранение исходного кода программного обеспечения Комплекса                              |
| content        | Сохранение пользовательского контента (загруженные файлы, изображения, документы и др.) |
| rosa_postgres  | Хранилище данных СУБД PostgreSQL. Обеспечивает сохранность при перезапуске контейнера   |
| rosa_redis     | Хранение данных Redis при включенной персистентности                                    |
| rosa_typesense | Сохранение индексов и данных поискового движка Typesense                                |
| themes         | Хранение тем оформления интерфейса и веб-страниц, созданных в CMS                       |

> Таблица 10 – Назначение томов Docker

_Примечание_ – В отличие от [раздела 4.1.4.](/developer/administrator/install-and-launch#_414-подготовка-постоянного-хранилища)
Подготовка постоянного хранилища в данной таблице представлены все фактически используемые тома,
включая `content`, `rosa_postgres`, `rosa_redis` и `rosa_typesense`.

Рекомендации по мониторингу томов Docker:

1. Проверка наличия и статуса томов. Для получения списка всех созданных томов использовать команду:

```bash Terminal
docker volume ls
```

2. Мониторинг объема хранилища. Для оценки занятого пространства можно использовать команды:

```bash Terminal
docker system df -v
```

или

```bash Terminal
docker inspect <имя_тома>
```

В выводах команды следует обратить внимание на поле Size.

3. Настройка регулярного резервного копирования критичных томов, особенно:

- `rosa_postgres` — база данных;
- `content` — пользовательские файлы;
- `code`; `themes` — конфигурации и визуальное оформление.

## 6.3 Рекомендации по мониторингу состояния Комплекса

Для обеспечения стабильной работы Комплекса рекомендуется настроить постоянный мониторинг его компонентов с
использованием специализированного программного обеспечения.
В качестве базового решения может быть использована система мониторинга
`Zabbix` ([https://www.zabbix.com.ru](https://www.zabbix.com.ru)) — свободно распространяемое ПО с
открытым исходным кодом, лицензированное под `GNU AGPLv3`.

### 6.3.1 Архитектура системы мониторинга

Для корректной работы `Zabbix` необходимо развертывание двух основных компонентов:

- сервер мониторинга — устанавливается на отдельный сервер под управлением \*nix-системы. Отвечает за сбор, обработку и хранение данных мониторинга.
- Zabbix-агент — устанавливается на сервер, на котором размещён Комплекс. Отправляет серверу мониторинга данные о состоянии ОС и служб.

Рекомендуется настроить оповещения по электронной почте или в мессенджере (например, `Telegram`)
при возникновении сбоев или достижении критических значений.

### 6.3.2 Мониторинг серверной инфраструктуры

Мониторинг должен охватывать как общесистемные показатели, так и состояния ключевых сервисов,
входящих в состав Комплекса. В таблице 11 приведён перечень служб и их состояний для отслеживания.

<div class="joplin-table-wrapper">
    <table>
        <thead>
            <tr>
                <th>
                    <p>Отслеживаемые службы</p>
                </th>
                <th>
                    <p>Состояния метрик</p>
                </th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <p>Операционная система</p>
                </td>
                <td>
                    <ul>
                        <li>Отсутствие соединения с агентом Zabbix;</li>
                        <li>Неактивность обязательных служб;</li>
                        <li>Нехватка свободного места на диске;</li>
                        <li>Недостаток свободной оперативной памяти;</li>
                        <li>Высокая нагрузка на дисковую подсистему;</li>
                        <li>Высокая нагрузка на оперативную память;</li>
                        <li>Перегрузка сетевого интерфейса;</li>
                        <li>Иные параметры, критически влияющие на работоспособность Комплекса</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Служба Docker</p>
                </td>
                <td>
                    <ul>
                        <li>Отсутствие сведений о статусе Docker;</li>
                        <li>Служба Docker не запущена;</li>
                        <li>Изменение версии Docker;</li>
                        <li>Ошибки в статусе контейнеров;</li>
                        <li>Аварийное завершение контейнеров (exit code ≠ 0);</li>
                        <li>Перегрузка процессора службой Docker;</li>
                        <li>Повышенное потребление памяти службой Docker</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Traefik</p>
                </td>
                <td>
                    <ul>
                        <li>Недоступность службы;</li>
                        <li>Неактивность процесса;</li>
                        <li>Изменение версии;</li>
                        <li>Повышенная загрузка CPU или RAM</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Nginx</p>
                </td>
                <td>
                    <ul>
                        <li>Недоступность службы;</li>
                        <li>Неактивность процесса;</li>
                        <li>Изменение версии;</li>
                        <li>Перегрузка по CPU или RAM;</li>
                        <li>Рост количества ошибок (4XX, 5XX);</li>
                        <li>Превышение лимитов по соединениям и отклику</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>PHP-FPM</p>
                </td>
                <td>
                    <ul>
                        <li>Недоступность или остановка службы;</li>
                        <li>Изменение версии;</li>
                        <li>Перегрузка процессора или памяти;</li>
                        <li>Превышение лимитов:</li>
                        <li>активных и idle процессов;</li>
                        <li>соединений в секунду;</li>
                        <li>медленных запросов;</li>
                        <li>очередей подключений</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Redis</p>
                </td>
                <td>
                    <ul>
                        <li>Недоступность службы;</li>
                        <li>Неактивность процесса;</li>
                        <li>Изменение версии;</li>
                        <li>Повышенная нагрузка на CPU или RAM;</li>
                        <li>Превышение лимитов по соединениям, процессам, очередям, медленным операциям</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>PostgreSQL</p>
                </td>
                <td>
                    <ul>
                        <li>Отсутствие доступа к службе;</li>
                        <li>Служба неактивна;</li>
                        <li>Изменение версии;</li>
                        <li>Повышенное использование CPU или RAM;</li>
                        <li>Превышение лимитов подключений, активных процессов, частоты запросов</li>
                    </ul>
                </td>
            </tr>
            <tr>
                <td>
                    <p>Typesense</p>
                </td>
                <td>
                    <ul>
                        <li>Отсутствие информации о состоянии службы;</li>
                        <li>Служба не запущена.;</li>
                        <li>Изменение версии;</li>
                        <li>Перегрузка по CPU или памяти</li>
                    </ul>
                </td>
            </tr>
        </tbody>
    </table>
</div>

> Таблица 11 – Список служб и их метрик

### 6.3.3 Мониторинг доступности веб-интерфейса

Необходимо регулярно проверять доступность и корректность отображения ключевых страниц Портала разработчика:

- главная страница;
- панель управления администратора;
- ошибки 4XX и 5XX на любых страницах;

Рекомендуется использовать внешние проверки (например, через HTTP-мониторинг `Zabbix` или специализированные скрипты),
чтобы контролировать отклик и корректность работы Комплекса как с точки зрения пользователя, так и администратора.
